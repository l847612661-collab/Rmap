<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºåœ°é£é™©å¹³é¢å›¾ - å±•ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #002D28;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
            max-width: 100vw;
        }

        .container {
            max-width: 100%;
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #002D28 0%, #00726d 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 28px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 20px;
            }
        }

        .header-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .legend {
            display: flex;
            gap: 30px;
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .legend {
                gap: 15px;
                padding: 10px 20px;
            }
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .risk-red { background: #dc3545; }
        .risk-orange { background: #fd7e14; }
        .risk-yellow { background: #ffc107; }
        .risk-blue { background: #0dcaf0; }

        .main-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: #f8f9fa;
            padding: 20px;
            min-height: 600px;
        }

        @media (max-width: 768px) {
            .main-view {
                padding: 15px;
                min-height: 400px;
            }
        }

        .workshop-map {
            width: 100%;
            max-width: 100%;
            position: relative;
            background: #f8f9fa;
            border: 3px solid #CCCCCC;
            border-radius: 10px;
            aspect-ratio: 16 / 9;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 1024px) {
            .workshop-map {
                aspect-ratio: 16 / 9;
            }
        }

        @media (max-width: 768px) {
            .workshop-map {
                aspect-ratio: 16 / 9;
            }
        }

        .workshop-map img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }

        .no-data {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666666;
            z-index: 0;
        }

        .area-box {
            position: absolute;
            border: 1px dashed rgba(0, 114, 109, 0.5);
            background: rgba(0, 114, 109, 0.05);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 5;
            pointer-events: auto;
        }

        .area-box:hover {
            background: rgba(0, 114, 109, 0.1);
            border: 2px solid rgba(0, 114, 109, 0.7);
            z-index: 8;
        }

        .area-label {
            position: absolute;
            top: -30px;
            left: 0;
            background: #00726d;
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .area-box:hover .area-label {
            opacity: 1;
        }

        .risk-point {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border: 2px solid white;
            animation: pulse 2s infinite;
            z-index: 20;
            pointer-events: auto;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            }
            50% {
                box-shadow: 0 3px 20px rgba(0, 0, 0, 0.5), 0 0 0 8px rgba(255, 255, 255, 0.1);
            }
        }

        .risk-point:hover {
            transform: scale(1.6);
            z-index: 100;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #002D28 0%, #00726d 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 22px;
            font-weight: bold;
        }

        .modal-close {
            font-size: 28px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
            max-height: calc(85vh - 80px);
            overflow-y: auto;
        }

        .detail-row {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .detail-label {
            font-weight: bold;
            color: #495057;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .detail-value {
            color: #212529;
            font-size: 15px;
        }

        .risk-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            color: white;
        }

        .stats {
            position: absolute;
            top: 20px;
            right: 20px;
            display: grid;
            grid-template-columns: repeat(2, 150px);
            gap: 10px;
            z-index: 100;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            font-size: 12px;
            margin-bottom: 8px;
            color: #6c757d;
        }

        .stat-card .number {
            font-size: 28px;
            font-weight: bold;
        }

        .refresh-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #00726d;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 114, 109, 0.4);
            transition: all 0.3s;
            z-index: 100;
        }

        .refresh-btn:hover {
            background: #002D28;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 114, 109, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ åŸºåœ°é£é™©å¹³é¢å›¾</h1>
            <div class="header-info">
                å®æ—¶ç›‘æ§ | æœ€åæ›´æ–°ï¼š<span id="updateTime"></span>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color risk-red"></div>
                <span><strong>çº¢è‰²</strong> - é‡å¤§é£é™©ï¼ˆ<span id="redCount">0</span>ï¼‰</span>
            </div>
            <div class="legend-item">
                <div class="legend-color risk-orange"></div>
                <span><strong>æ©™è‰²</strong> - è¾ƒå¤§é£é™©ï¼ˆ<span id="orangeCount">0</span>ï¼‰</span>
            </div>
            <div class="legend-item">
                <div class="legend-color risk-yellow"></div>
                <span><strong>é»„è‰²</strong> - ä¸€èˆ¬é£é™©ï¼ˆ<span id="yellowCount">0</span>ï¼‰</span>
            </div>
            <div class="legend-item">
                <div class="legend-color risk-blue"></div>
                <span><strong>è“è‰²</strong> - ä½é£é™©ï¼ˆ<span id="blueCount">0</span>ï¼‰</span>
            </div>
        </div>

        <div class="main-view">
            <div class="workshop-map" id="workshopMap">
                <img id="workshopImage" style="display: none;" alt="è½¦é—´å¹³é¢å›¾">
                <div class="no-data" id="noData">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“‹</div>
                    <div style="font-size: 18px; font-weight: bold;">æš‚æ— æ•°æ®</div>
                    <div style="font-size: 14px; margin-top: 10px;">è¯·åœ¨åå°ç®¡ç†é¡µé¢ä¸Šä¼ æ•°æ®</div>
                </div>
            </div>

            <button class="refresh-btn" onclick="manualRefresh()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="detail-row">
                    <div class="detail-label">ğŸ¨ é£é™©ç­‰çº§</div>
                    <div class="detail-value">
                        <span class="risk-badge" id="modalBadge"></span>
                    </div>
                </div>
                <div class="detail-row" id="areaRow">
                    <div class="detail-label">ğŸ“¦ æ‰€å±åŒºåŸŸ</div>
                    <div class="detail-value" id="modalArea"></div>
                </div>
                <div class="detail-row" id="codeRow">
                    <div class="detail-label">ğŸ”¢ é£é™©ä»£ç </div>
                    <div class="detail-value" id="modalCode"></div>
                </div>
                <div class="detail-row" id="descriptionRow">
                    <div class="detail-label">ğŸ“ é£é™©æè¿°</div>
                    <div class="detail-value" id="modalDescription" style="white-space: pre-wrap;"></div>
                </div>
                <div class="detail-row" id="typeRow">
                    <div class="detail-label">âš ï¸ æ˜“å‘ç”Ÿçš„äº‹æ•…ç±»å‹</div>
                    <div class="detail-value" id="modalType"></div>
                </div>
                <div class="detail-row" id="measuresRow">
                    <div class="detail-label">ğŸ›¡ï¸ ä¸»è¦ç®¡æ§æªæ–½</div>
                    <div class="detail-value" id="modalMeasures" style="white-space: pre-wrap;"></div>
                </div>
                <div class="detail-row" id="deptRow">
                    <div class="detail-label">ğŸ¢ è´£ä»»éƒ¨é—¨</div>
                    <div class="detail-value" id="modalDept"></div>
                </div>
                <div class="detail-row" id="responsibleRow">
                    <div class="detail-label">ğŸ‘¤ è´£ä»»äºº</div>
                    <div class="detail-value" id="modalResponsible"></div>
                </div>
                <div class="detail-row" id="photoRow">
                    <div class="detail-label">ğŸ“· é£é™©ç‚¹ç…§ç‰‡</div>
                    <div class="detail-value">
                        <img id="modalPhoto" src="" style="max-width: 100%; max-height: 300px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer;" onclick="showPhotoZoom(this.src)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŒºåŸŸå››è‰²å›¾æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="modal" id="areaDetailImageModal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-title" id="areaDetailImageTitle">ğŸ“Š åŒºåŸŸå››è‰²å›¾</div>
                <span class="modal-close" onclick="closeAreaDetailImageModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <!-- é£é™©ç‚¹ç»Ÿè®¡ -->
                <div id="areaRiskStats" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #002D28; font-size: 18px;">ğŸ“‹ é£é™©ç‚¹ç»Ÿè®¡</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #dc3545;" id="modalRedCount">0</div>
                            <div style="color: #666; margin-top: 5px;">ğŸ”´ é‡å¤§é£é™©</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #fd7e14; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #fd7e14;" id="modalOrangeCount">0</div>
                            <div style="color: #666; margin-top: 5px;">ğŸŸ  è¾ƒå¤§é£é™©</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #ffc107;" id="modalYellowCount">0</div>
                            <div style="color: #666; margin-top: 5px;">ğŸŸ¡ ä¸€èˆ¬é£é™©</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #0dcaf0; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #0dcaf0;" id="modalBlueCount">0</div>
                            <div style="color: #666; margin-top: 5px;">ğŸ”µ ä½é£é™©</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px; text-align: center;">
                        <span style="font-size: 16px; color: #666;">æ€»è®¡ï¼š</span>
                        <span style="font-size: 24px; font-weight: bold; color: #002D28;" id="modalTotalCount">0</span>
                        <span style="font-size: 16px; color: #666;"> ä¸ªé£é™©ç‚¹</span>
                    </div>
                </div>

                <!-- å››è‰²å›¾ -->
                <div id="areaDetailImageContainer">
                    <h3 style="margin: 0 0 15px 0; color: #002D28; font-size: 18px;">ğŸ–¼ï¸ åŒºåŸŸè¯¦ç»†å››è‰²å›¾</h3>
                    <div id="detailImagesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                    </div>
                    <div id="noDetailImage" style="padding: 40px; background: #f8f9fa; border: 2px dashed #CCCCCC; border-radius: 8px; color: #6c757d; text-align: center; display: none;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</div>
                        <div>è¯¥åŒºåŸŸæš‚æ— è¯¦ç»†å››è‰²å›¾</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="modal" id="imageZoomModal" style="background: rgba(0, 0, 0, 0.95);">
        <div style="position: relative; width: 95%; height: 95%; display: flex; align-items: center; justify-content: center;">
            <span onclick="closeImageZoom()" style="position: absolute; top: 20px; right: 30px; font-size: 40px; color: white; cursor: pointer; z-index: 10;">
                &times;
            </span>
            <img id="zoomedImage" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;">
        </div>
    </div>

    <script>
        let data = null;

        const riskColors = {
            red: '#dc3545',
            orange: '#fd7e14',
            yellow: '#ffc107',
            blue: '#0dcaf0'
        };

        const riskLabels = {
            red: 'é‡å¤§é£é™©',
            orange: 'è¾ƒå¤§é£é™©',
            yellow: 'ä¸€èˆ¬é£é™©',
            blue: 'ä½é£é™©'
        };

        // æ ¹æ®åŒºåŸŸå†…é£é™©ç‚¹çš„æ•°é‡å’Œç­‰çº§ï¼Œè®¡ç®—åŒºåŸŸçš„é£é™©ç³»æ•°
        function calculateAreaRiskScore(areaId) {
            if (!data || !data.riskPoints) return 0;
            const risksInArea = data.riskPoints.filter(r => r.areaId == areaId);
            if (risksInArea.length === 0) return 0;

            // é£é™©ç­‰çº§æƒé‡
            const weights = {
                red: 4,    // é‡å¤§é£é™©
                orange: 3, // è¾ƒå¤§é£é™©
                yellow: 2, // ä¸€èˆ¬é£é™©
                blue: 1    // ä½é£é™©
            };

            // è®¡ç®—åŠ æƒæ€»åˆ†
            let totalScore = 0;
            risksInArea.forEach(risk => {
                totalScore += weights[risk.level] || 0;
            });

            return totalScore;
        }

        // è·å–æ‰€æœ‰åŒºåŸŸçš„æœ€å¤§é£é™©ç³»æ•°ï¼ˆç”¨äºå½’ä¸€åŒ–ï¼‰
        function getMaxRiskScore() {
            if (!data || !data.areas) return 1;
            let maxScore = 0;
            data.areas.forEach(area => {
                const score = calculateAreaRiskScore(area.id);
                if (score > maxScore) maxScore = score;
            });
            return maxScore || 1; // é¿å…é™¤ä»¥0
        }

        // æ ¹æ®é£é™©ç³»æ•°è·å–é¢œè‰²ï¼ˆè“è‰²â†’é»„è‰²â†’æ©™è‰²â†’çº¢è‰²æ¸å˜ï¼‰
        function getColorByRiskScore(score, maxScore) {
            if (score === 0) {
                // æ— é£é™©ï¼Œè¿”å›é»˜è®¤æ·¡é’ç»¿è‰²
                return {
                    background: 'rgba(0, 114, 109, 0.05)',
                    border: 'rgba(0, 114, 109, 0.5)'
                };
            }

            // å½’ä¸€åŒ–åˆ°0-1
            const normalized = score / maxScore;

            let r, g, b;

            if (normalized <= 0.33) {
                // è“è‰² (13, 202, 240) â†’ é»„è‰² (255, 193, 7)
                const t = normalized / 0.33;
                r = Math.round(13 + (255 - 13) * t);
                g = Math.round(202 + (193 - 202) * t);
                b = Math.round(240 + (7 - 240) * t);
            } else if (normalized <= 0.67) {
                // é»„è‰² (255, 193, 7) â†’ æ©™è‰² (253, 126, 20)
                const t = (normalized - 0.33) / 0.34;
                r = Math.round(255 + (253 - 255) * t);
                g = Math.round(193 + (126 - 193) * t);
                b = Math.round(7 + (20 - 7) * t);
            } else {
                // æ©™è‰² (253, 126, 20) â†’ çº¢è‰² (220, 53, 69)
                const t = (normalized - 0.67) / 0.33;
                r = Math.round(253 + (220 - 253) * t);
                g = Math.round(126 + (53 - 126) * t);
                b = Math.round(20 + (69 - 20) * t);
            }

            return {
                background: `rgba(${r}, ${g}, ${b}, 0.15)`,
                border: `rgba(${r}, ${g}, ${b}, 0.6)`
            };
        }

        // åŠ è½½æ•°æ®
        function loadData() {
            // å¼ºåˆ¶åˆ·æ–° localStorage
            try {
                const savedData = localStorage.getItem('workshopRiskData');
                if (!savedData) {
                    document.getElementById('noData').style.display = 'block';
                    return;
                }

                data = JSON.parse(savedData);
                document.getElementById('noData').style.display = 'none';
                render();
                updateStats();
                updateTime();
                console.log('æ•°æ®å·²åˆ·æ–°:', new Date().toLocaleString());
            } catch (e) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥', e);
                alert('æ•°æ®æ ¼å¼é”™è¯¯ï¼š' + e.message);
            }
        }

        // æ¸²æŸ“åœ°å›¾
        function render() {
            const map = document.getElementById('workshopMap');

            // æ¸…ç©º
            map.querySelectorAll('.area-box, .risk-point').forEach(el => el.remove());

            // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
            if (data.backgroundImage) {
                const img = document.getElementById('workshopImage');
                img.src = data.backgroundImage;
                img.style.display = 'block';
            }

            // è®¡ç®—æœ€å¤§é£é™©ç³»æ•°ï¼ˆç”¨äºå½’ä¸€åŒ–ï¼‰
            const maxScore = getMaxRiskScore();

            // æ¸²æŸ“åŒºåŸŸ
            if (data.areas) {
                data.areas.forEach(area => {
                    const box = document.createElement('div');
                    box.className = 'area-box';
                    box.style.left = area.x + '%';
                    box.style.top = area.y + '%';
                    box.style.width = area.width + '%';
                    box.style.height = area.height + '%';

                    // æ ¹æ®é£é™©ç³»æ•°è®¾ç½®é¢œè‰²
                    const riskScore = calculateAreaRiskScore(area.id);
                    const colors = getColorByRiskScore(riskScore, maxScore);
                    box.style.background = colors.background;
                    box.style.borderColor = colors.border;

                    const label = document.createElement('div');
                    label.className = 'area-label';
                    label.textContent = area.name;
                    box.appendChild(label);

                    // åŒå‡»æ˜¾ç¤ºåŒºåŸŸè¯¦æƒ…ï¼ˆå«å››è‰²å›¾å’Œé£é™©ç‚¹ç»Ÿè®¡ï¼‰
                    box.ondblclick = function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        showAreaDetailImage(area);
                    };

                    map.appendChild(box);
                });
            }

            // æ¸²æŸ“é£é™©ç‚¹
            if (data.riskPoints) {
                data.riskPoints.forEach(risk => {
                    const point = document.createElement('div');
                    point.className = 'risk-point';
                    point.style.left = risk.x + '%';
                    point.style.top = risk.y + '%';
                    point.style.background = riskColors[risk.level];
                    point.textContent = 'âš ';
                    point.title = risk.name;

                    point.onclick = function(e) {
                        e.stopPropagation();
                        showRiskDetail(risk);
                    };

                    map.appendChild(point);
                });
            }
        }

        // æ˜¾ç¤ºåŒºåŸŸä¿¡æ¯
        function showAreaInfo(area) {
            const risksInArea = data.riskPoints.filter(r => r.areaId == area.id);
            const info = `åŒºåŸŸï¼š${area.name}\nåŒ…å«é£é™©ç‚¹ï¼š${risksInArea.length} ä¸ª`;
            alert(info);
        }

        // æ˜¾ç¤ºé£é™©ç‚¹è¯¦æƒ…
        function showRiskDetail(risk) {
            document.getElementById('modalTitle').textContent = risk.name;

            const badge = document.getElementById('modalBadge');
            badge.textContent = riskLabels[risk.level];
            badge.style.background = riskColors[risk.level];

            // æ‰€å±åŒºåŸŸ
            const areaRow = document.getElementById('areaRow');
            if (risk.areaId) {
                const area = data.areas.find(a => a.id == risk.areaId);
                document.getElementById('modalArea').textContent = area ? area.name : 'æœªçŸ¥åŒºåŸŸ';
                areaRow.style.display = 'block';
            } else {
                areaRow.style.display = 'none';
            }

            // é£é™©ä»£ç 
            const codeRow = document.getElementById('codeRow');
            if (risk.riskCode) {
                document.getElementById('modalCode').textContent = risk.riskCode;
                codeRow.style.display = 'block';
            } else {
                codeRow.style.display = 'none';
            }

            // é£é™©æè¿°
            const descriptionRow = document.getElementById('descriptionRow');
            if (risk.riskDescription) {
                document.getElementById('modalDescription').textContent = risk.riskDescription;
                descriptionRow.style.display = 'block';
            } else {
                descriptionRow.style.display = 'none';
            }

            // é£é™©ç±»å‹
            const typeRow = document.getElementById('typeRow');
            if (risk.riskType) {
                document.getElementById('modalType').textContent = risk.riskType;
                typeRow.style.display = 'block';
            } else {
                typeRow.style.display = 'none';
            }

            // ä¸»è¦ç®¡æ§æªæ–½
            const measuresRow = document.getElementById('measuresRow');
            if (risk.controlMeasures) {
                document.getElementById('modalMeasures').textContent = risk.controlMeasures;
                measuresRow.style.display = 'block';
            } else {
                measuresRow.style.display = 'none';
            }

            // è´£ä»»éƒ¨é—¨
            const deptRow = document.getElementById('deptRow');
            if (risk.responsibleDept) {
                document.getElementById('modalDept').textContent = risk.responsibleDept;
                deptRow.style.display = 'block';
            } else {
                deptRow.style.display = 'none';
            }

            // è´£ä»»äºº
            const responsibleRow = document.getElementById('responsibleRow');
            if (risk.responsible) {
                document.getElementById('modalResponsible').textContent = risk.responsible;
                responsibleRow.style.display = 'block';
            } else {
                responsibleRow.style.display = 'none';
            }

            // é£é™©ç‚¹ç…§ç‰‡
            const photoRow = document.getElementById('photoRow');
            if (risk.photo) {
                document.getElementById('modalPhoto').src = risk.photo;
                photoRow.style.display = 'block';
            } else {
                photoRow.style.display = 'none';
            }

            document.getElementById('detailModal').classList.add('active');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        document.getElementById('detailModal').onclick = function(e) {
            if (e.target === this) closeModal();
        };

        // æ˜¾ç¤ºåŒºåŸŸå››è‰²å›¾å’Œç»Ÿè®¡
        function showAreaDetailImage(area) {
            document.getElementById('areaDetailImageTitle').textContent = `ğŸ“Š ${area.name} - åŒºåŸŸè¯¦æƒ…`;

            // ç»Ÿè®¡è¯¥åŒºåŸŸçš„é£é™©ç‚¹æ•°é‡ï¼ˆåˆ†çº§ï¼‰
            const risksInArea = data.riskPoints.filter(r => r.areaId == area.id);
            const counts = { red: 0, orange: 0, yellow: 0, blue: 0 };
            risksInArea.forEach(r => {
                if (counts.hasOwnProperty(r.level)) {
                    counts[r.level]++;
                }
            });

            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤ºï¼ˆä½¿ç”¨æ¨¡æ€æ¡†ä¸“ç”¨çš„IDï¼‰
            document.getElementById('modalRedCount').textContent = counts.red;
            document.getElementById('modalOrangeCount').textContent = counts.orange;
            document.getElementById('modalYellowCount').textContent = counts.yellow;
            document.getElementById('modalBlueCount').textContent = counts.blue;
            document.getElementById('modalTotalCount').textContent = risksInArea.length;

            // å¤„ç†å¤šå¼ å››è‰²å›¾æ˜¾ç¤ºï¼ˆå‘åå…¼å®¹ï¼‰
            let images = [];
            if (area.detailImages && area.detailImages.length > 0) {
                images = area.detailImages;
            } else if (area.detailImage) {
                images = [area.detailImage];
            }

            const gridContainer = document.getElementById('detailImagesGrid');
            const noImagePlaceholder = document.getElementById('noDetailImage');

            if (images.length === 0) {
                gridContainer.innerHTML = '';
                gridContainer.style.display = 'none';
                noImagePlaceholder.style.display = 'block';
            } else {
                noImagePlaceholder.style.display = 'none';
                gridContainer.style.display = 'grid';
                gridContainer.innerHTML = images.map((img, index) => `
                    <div style="position: relative; cursor: pointer; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"
                         onclick="showImageZoom('${img.replace(/'/g, "\\'")}')">
                        <img src="${img}" style="width: 100%; height: 200px; object-fit: cover; display: block;" alt="å››è‰²å›¾ ${index + 1}">
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
                                    padding: 10px; color: white; text-align: center; font-size: 12px;">
                            å›¾ç‰‡ ${index + 1} - åŒå‡»æ”¾å¤§æŸ¥çœ‹
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('areaDetailImageModal').classList.add('active');
        }

        // æ˜¾ç¤ºå›¾ç‰‡æ”¾å¤§
        function showImageZoom(imageSrc) {
            document.getElementById('zoomedImage').src = imageSrc;
            document.getElementById('imageZoomModal').classList.add('active');
        }

        // æ˜¾ç¤ºé£é™©ç‚¹ç…§ç‰‡æ”¾å¤§ï¼ˆå¤ç”¨showImageZoomï¼‰
        function showPhotoZoom(photoSrc) {
            showImageZoom(photoSrc);
        }

        // å…³é—­å›¾ç‰‡æ”¾å¤§
        function closeImageZoom() {
            document.getElementById('imageZoomModal').classList.remove('active');
        }

        // å…³é—­åŒºåŸŸå››è‰²å›¾æ¨¡æ€æ¡†
        function closeAreaDetailImageModal() {
            document.getElementById('areaDetailImageModal').classList.remove('active');
        }

        document.getElementById('areaDetailImageModal').onclick = function(e) {
            if (e.target === this) closeAreaDetailImageModal();
        };

        document.getElementById('imageZoomModal').onclick = function(e) {
            if (e.target === this) closeImageZoom();
        };

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            if (!data || !data.riskPoints) return;

            const counts = { red: 0, orange: 0, yellow: 0, blue: 0 };
            data.riskPoints.forEach(r => counts[r.level]++);

            document.getElementById('redCount').textContent = counts.red;
            document.getElementById('orangeCount').textContent = counts.orange;
            document.getElementById('yellowCount').textContent = counts.yellow;
            document.getElementById('blueCount').textContent = counts.blue;
        }

        // æ›´æ–°æ—¶é—´
        function updateTime() {
            const now = new Date();
            document.getElementById('updateTime').textContent = now.toLocaleString('zh-CN');
        }

        // æ‰‹åŠ¨åˆ·æ–°ï¼ˆå¸¦åé¦ˆï¼‰
        function manualRefresh() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ğŸ”„ åˆ·æ–°ä¸­...';
            btn.disabled = true;

            // æ¸…é™¤ç°æœ‰æ•°æ®å¼ºåˆ¶é‡æ–°åŠ è½½
            setTimeout(() => {
                loadData();
                btn.innerHTML = 'âœ… åˆ·æ–°æˆåŠŸ';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1000);
            }, 300);
        }

        // ç›‘å¬ localStorage å˜åŒ–ï¼ˆå½“åå°ç®¡ç†é¡µé¢æ›´æ–°æ•°æ®æ—¶è‡ªåŠ¨åˆ·æ–°ï¼‰
        window.addEventListener('storage', function(e) {
            if (e.key === 'workshopRiskData') {
                console.log('æ£€æµ‹åˆ°æ•°æ®æ›´æ–°ï¼Œè‡ªåŠ¨åˆ·æ–°');
                loadData();
            }
        });

        // è‡ªåŠ¨åˆ·æ–°
        setInterval(loadData, 30000);  // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°

        // åˆå§‹åŒ–
        window.onload = loadData;
    </script>
</body>
</html>