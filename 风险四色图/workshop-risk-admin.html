<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºåœ°é£é™©å¹³é¢å›¾ - åå°ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #002D28 0%, #00726d 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            max-width: 100vw;
        }

        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #002D28 0%, #00726d 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 28px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 20px;
            }
        }

        .header-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .header-actions {
                gap: 10px;
                width: 100%;
                justify-content: flex-start;
            }
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .btn {
                padding: 8px 15px;
                font-size: 13px;
            }
        }

        .btn-primary {
            background: #00726d;
            color: white;
        }

        .btn-primary:hover {
            background: #002D28;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #CEA472;
            color: white;
        }

        .btn-success:hover {
            background: #b8936a;
        }

        .btn-warning {
            background: #CEA472;
            color: white;
        }

        .btn-warning:hover {
            background: #b8936a;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #bb2d3b;
        }

        .btn-light {
            background: white;
            color: #002D28;
            border: 1px solid #CCCCCC;
        }

        .btn-light:hover {
            background: #f8f9fa;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr minmax(280px, 20%);
            gap: 0;
            min-height: calc(100vh - 60px);
            align-items: stretch;
            width: 100%;
            overflow: hidden;
        }

        /* å“åº”å¼æ–­ç‚¹ */
        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 1fr minmax(280px, 25%);
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr 280px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }
        }

        .workspace {
            padding: 20px;
            border-right: 2px solid #CCCCCC;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .workspace {
                padding: 15px;
                border-right: none;
                border-bottom: 2px solid #CCCCCC;
            }
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .workshop-map {
            width: 100%;
            max-width: 100%;
            position: relative;
            background: #f8f9fa;
            border: 3px solid #CCCCCC;
            border-radius: 10px;
            aspect-ratio: 16 / 9;
            cursor: crosshair;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 1024px) {
            .workshop-map {
                aspect-ratio: 16 / 9;
            }
        }

        @media (max-width: 768px) {
            .workshop-map {
                aspect-ratio: 16 / 9;
            }
        }

        .workshop-map img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }

        .upload-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #6c757d;
            z-index: 0;
        }

        .upload-placeholder.hidden {
            display: none;
        }

        /* åŒºåŸŸæ¡†æ ·å¼ */
        .area-box {
            position: absolute;
            border: 1px dashed rgba(0, 114, 109, 0.5);
            background: rgba(0, 114, 109, 0.05);
            cursor: move;
            z-index: 5;
            transition: all 0.3s;
            pointer-events: auto;
        }

        .area-box:hover {
            border: 2px solid rgba(0, 114, 109, 0.7);
            background: rgba(0, 114, 109, 0.1);
        }

        .area-box.selected {
            border: 2px solid #CEA472;
            background: rgba(206, 164, 114, 0.1);
            box-shadow: 0 0 0 3px rgba(206, 164, 114, 0.2);
            z-index: 8;
        }

        .area-label {
            position: absolute;
            top: -30px;
            left: 0;
            background: #00726d;
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .area-box:hover .area-label {
            opacity: 1;
        }

        .area-box.selected .area-label {
            background: #CEA472;
            color: white;
            opacity: 1;
        }

        /* ä¸´æ—¶åæ ‡æ ‡è®° */
        .temp-marker {
            position: absolute;
            width: 14px;
            height: 14px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 50;
            animation: markerPulse 1s infinite;
        }

        @keyframes markerPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.8;
            }
        }

        /* é£é™©ç‚¹æ ·å¼ */
        .risk-point {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border: 2px solid white;
            z-index: 20;
            pointer-events: auto;
        }

        .risk-point:hover {
            transform: scale(1.6);
            z-index: 100;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 20px 15px 20px;
            overflow-y: auto;
            overflow-x: hidden;
            min-width: 0;
            max-width: 100%;
            height: calc(115vh - 60px);
            position: sticky;
            top: 0;
        }

        @media (max-width: 1024px) {
            .sidebar {
                padding: 15px 10px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                padding: 20px;
                max-height: none;
            }
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #002D28;
            font-size: 18px;
            border-bottom: 2px solid #CCCCCC;
            padding-bottom: 10px;
        }

        .sidebar h3:first-child {
            margin-top: 0;
        }

        .upload-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px dashed #CCCCCC;
        }

        .upload-section:last-child {
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background: #00726d;
            color: white;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .file-input-label:hover {
            background: #002D28;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333333;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            max-width: 100%;
            padding: 10px;
            border: 1px solid #CCCCCC;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #00726d;
            box-shadow: 0 0 0 3px rgba(0, 114, 109, 0.1);
        }

        .list-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #CCCCCC;
        }

        .list-item:hover {
            border-color: #00726d;
            transform: translateX(5px);
        }

        .list-item.selected {
            border-color: #CEA472;
            background: rgba(206, 164, 114, 0.1);
        }

        .list-item-delete {
            color: #dc3545;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .list-item-delete:hover {
            background: #dc3545;
            color: white;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #cff4fc;
            border-color: #0dcaf0;
            color: #055160;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #664d03;
        }

        .risk-red { background: #dc3545; }
        .risk-orange { background: #fd7e14; }
        .risk-yellow { background: #ffc107; }
        .risk-blue { background: #0dcaf0; }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #002D28 0%, #00726d 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 22px;
            font-weight: bold;
        }

        .modal-close {
            font-size: 28px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ åŸºåœ°é£é™©å¹³é¢å›¾ - åå°ç®¡ç†</h1>
            <div class="header-actions">
                <button class="btn btn-warning" onclick="showHelp()">â“ æ“ä½œè¯´æ˜</button>
                <button class="btn btn-success" onclick="exportAllData()">ğŸ“¥ å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
                <button class="btn btn-light" onclick="openDisplayPage()">ğŸ‘ï¸ æŸ¥çœ‹å±•ç¤ºé¡µé¢</button>
            </div>
        </div>

        <div class="main-content">
            <div class="workspace">
                <div class="toolbar">
                    <button class="btn btn-primary" id="selectModeBtn" onclick="setMode('select')">
                        âš¡ é€‰æ‹©æ¨¡å¼
                    </button>
                    <button class="btn btn-warning" id="drawModeBtn" onclick="setMode('draw')">
                        âœï¸ æ¡†é€‰åŒºåŸŸ
                    </button>
                    <button class="btn btn-success" id="addRiskBtn" onclick="setMode('addRisk')">
                        â• æ·»åŠ é£é™©ç‚¹
                    </button>
                    <button class="btn btn-danger" onclick="deleteSelected()">
                        ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­
                    </button>
                </div>

                <div class="workshop-map" id="workshopMap">
                    <img id="workshopImage" style="display: none;" alt="è½¦é—´å¹³é¢å›¾">
                    <div class="upload-placeholder" id="uploadPlaceholder">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“¤</div>
                        <div style="font-size: 18px; font-weight: bold;">è¯·å…ˆä¸Šä¼ è½¦é—´å¹³é¢å›¾</div>
                        <div style="font-size: 14px; margin-top: 5px;">æ”¯æŒ JPGã€PNG æ ¼å¼</div>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <h3>ğŸ“¤ ä¸Šä¼ å¹³é¢å›¾</h3>
                <div class="upload-section">
                    <div class="file-input-wrapper">
                        <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)">
                        <label for="imageUpload" class="file-input-label">
                            ğŸ“ é€‰æ‹©å¹³é¢å›¾
                        </label>
                    </div>
                    <div id="imageInfo" style="margin-top: 10px; font-size: 12px; color: #6c757d;"></div>
                </div>

                <div id="areaPanel" style="display: none;">
                    <h3>âœï¸ åŒºåŸŸä¿¡æ¯</h3>
                    <div class="alert alert-info">
                        å½“å‰æ¨¡å¼ï¼šæ¡†é€‰åŒºåŸŸ
                    </div>
                    <div class="form-group">
                        <label>åŒºåŸŸåç§° *</label>
                        <input type="text" class="form-control" id="areaName" placeholder="ä¾‹å¦‚ï¼šç”Ÿäº§åŒºA">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="saveArea()">
                        ğŸ’¾ ä¿å­˜åŒºåŸŸ
                    </button>
                </div>

                <div id="riskPanel" style="display: none;">
                    <h3>âœï¸ é£é™©ç‚¹ä¿¡æ¯</h3>
                    <div class="alert alert-info" id="riskPanelHint">
                        ç‚¹å‡»åœ°å›¾æ·»åŠ é£é™©ç‚¹
                    </div>
                    <input type="hidden" id="editingRiskId" value="">
                    <div class="form-group">
                        <label>æ‰€å±åŒºåŸŸ</label>
                        <div class="form-control" id="riskArea" style="background: #e9ecef; color: #495057;">
                            ï¼ˆç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«ï¼‰
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é£é™©ç‚¹åç§° *</label>
                        <input type="text" class="form-control" id="riskName" placeholder="ä¾‹å¦‚ï¼šè®¾å¤‡A">
                    </div>
                    <div class="form-group">
                        <label>é£é™©ä»£ç </label>
                        <input type="text" class="form-control" id="riskCode" placeholder="ä¾‹å¦‚ï¼šFX-001">
                    </div>
                    <div class="form-group">
                        <label>é£é™©ç­‰çº§ *</label>
                        <select class="form-control" id="riskLevel">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="red">ğŸ”´ é‡å¤§é£é™©</option>
                            <option value="orange">ğŸŸ  è¾ƒå¤§é£é™©</option>
                            <option value="yellow">ğŸŸ¡ ä¸€èˆ¬é£é™©</option>
                            <option value="blue">ğŸ”µ ä½é£é™©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é£é™©æè¿°</label>
                        <textarea class="form-control" id="riskDescription" rows="2" placeholder="æè¿°é£é™©å†…å®¹..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>åæ ‡ä½ç½® <span style="font-size: 12px; color: #6c757d;">(ç‚¹å‡»åœ°å›¾å¯é‡æ–°å®šä½)</span></label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <input type="number" class="form-control" id="riskX" placeholder="Xåæ ‡%"
                                       min="0" max="100" step="0.1" readonly>
                            </div>
                            <div>
                                <input type="number" class="form-control" id="riskY" placeholder="Yåæ ‡%"
                                       min="0" max="100" step="0.1" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ˜“å‘ç”Ÿçš„äº‹æ•…ç±»å‹</label>
                        <input type="text" class="form-control" id="riskType" placeholder="ä¾‹å¦‚ï¼šæœºæ¢°ä¼¤å®³">
                    </div>
                    <div class="form-group">
                        <label>ä¸»è¦ç®¡æ§æªæ–½</label>
                        <textarea class="form-control" id="controlMeasures" rows="3" placeholder="æè¿°ç®¡æ§æªæ–½..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>è´£ä»»éƒ¨é—¨</label>
                        <input type="text" class="form-control" id="responsibleDept" placeholder="ä¾‹å¦‚ï¼šç”Ÿäº§éƒ¨">
                    </div>
                    <div class="form-group">
                        <label>è´£ä»»äºº</label>
                        <input type="text" class="form-control" id="riskResponsible" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰">
                    </div>
                    <div class="form-group">
                        <label>é£é™©ç‚¹ç…§ç‰‡</label>
                        <div style="margin-bottom: 10px;">
                            <input type="file" id="riskPhotoInput" accept="image/*" style="display: none;" onchange="handleRiskPhotoUpload(event)">
                            <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="document.getElementById('riskPhotoInput').click()">
                                ğŸ“· ä¸Šä¼ ç…§ç‰‡
                            </button>
                        </div>
                        <div id="riskPhotoPreview" style="display: none; margin-top: 10px;">
                            <img id="riskPhotoImg" src="" style="width: 100%; max-height: 200px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 4px;">
                            <button type="button" class="btn btn-danger" style="width: 100%; margin-top: 5px;" onclick="clearRiskPhoto()">
                                âŒ åˆ é™¤ç…§ç‰‡
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="saveRisk()">
                        ğŸ’¾ ä¿å­˜é£é™©ç‚¹
                    </button>
                    <button class="btn btn-danger" style="width: 100%;" onclick="cancelRisk()">
                        âŒ å–æ¶ˆ
                    </button>
                </div>

                <h3 style="margin-top: 25px;">ğŸ“¦ åŒºåŸŸåˆ—è¡¨ (<span id="areaCount">0</span>)</h3>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="showAreaListModal()">
                    ğŸ“‹ æŸ¥çœ‹åŒºåŸŸåˆ—è¡¨
                </button>

                <h3 style="margin-top: 25px;">ğŸ“‹ é£é™©ç‚¹åˆ—è¡¨ (<span id="riskCount">0</span>)</h3>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="showRiskListModal()">
                    ğŸ“‹ æŸ¥çœ‹é£é™©ç‚¹åˆ—è¡¨
                </button>

                <h3 style="margin-top: 25px;">ğŸ“Š æ‰¹é‡å¯¼å…¥é£é™©ç‚¹</h3>
                <div class="upload-section" style="border-color: #198754;">
                    <div class="file-input-wrapper">
                        <input type="file" id="excelUpload" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
                        <label for="excelUpload" class="file-input-label" style="background: #198754;">
                            ğŸ“Š ä¸Šä¼ Excelè¡¨æ ¼
                        </label>
                    </div>
                    <button class="btn btn-success" style="margin-top: 10px; width: 100%;" onclick="downloadTemplate()">
                        ğŸ“¥ ä¸‹è½½Excelæ¨¡æ¿
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŒºåŸŸåˆ—è¡¨å¼¹çª— -->
    <div class="modal" id="areaListModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">ğŸ“¦ åŒºåŸŸåˆ—è¡¨</div>
                <span class="modal-close" onclick="closeAreaListModal()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="areaListContent"></div>
            </div>
        </div>
    </div>

    <!-- é£é™©ç‚¹åˆ—è¡¨å¼¹çª— -->
    <div class="modal" id="riskListModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button id="backToAreaListBtn" style="display: none; padding: 5px 10px; background: #00726d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;"
                            onclick="backToAreaList()">
                        â† è¿”å›åŒºåŸŸåˆ—è¡¨
                    </button>
                    <div class="modal-title">ğŸ“‹ é£é™©ç‚¹åˆ—è¡¨</div>
                </div>
                <span class="modal-close" onclick="closeRiskListModal()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- ç­›é€‰å™¨ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="riskSearchInput" placeholder="ğŸ” æœç´¢é£é™©ç‚¹åç§°..."
                                   style="width: 100%; padding: 8px 12px; border: 1px solid #CCCCCC; border-radius: 5px; font-size: 13px;"
                                   oninput="filterRiskList()">
                        </div>
                        <div>
                            <select id="riskLevelFilter" style="padding: 8px 12px; border: 1px solid #CCCCCC; border-radius: 5px; font-size: 13px;"
                                    onchange="filterRiskList()">
                                <option value="">å…¨éƒ¨ç­‰çº§</option>
                                <option value="red">ğŸ”´ çº¢è‰²</option>
                                <option value="orange">ğŸŸ  æ©™è‰²</option>
                                <option value="yellow">ğŸŸ¡ é»„è‰²</option>
                                <option value="blue">ğŸ”µ è“è‰²</option>
                            </select>
                        </div>
                        <div>
                            <select id="riskAreaFilter" style="padding: 8px 12px; border: 1px solid #CCCCCC; border-radius: 5px; font-size: 13px;"
                                    onchange="filterRiskList()">
                                <option value="">å…¨éƒ¨åŒºåŸŸ</option>
                            </select>
                        </div>
                        <button onclick="resetRiskFilters()" style="padding: 8px 15px; background: #CEA472; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
                            ğŸ”„ é‡ç½®
                        </button>
                    </div>
                </div>
                <div id="riskListContent"></div>
            </div>
        </div>
    </div>

    <!-- å¸®åŠ©è¯´æ˜æ¨¡æ€æ¡† -->
    <div class="modal" id="helpModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">ğŸ“– æ“ä½œè¯´æ˜</div>
                <span class="modal-close" onclick="closeHelp()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">ğŸ¯ å¿«é€Ÿå¼€å§‹</h3>

                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ è½¦é—´å¹³é¢å›¾</h4>
                    <p style="margin: 0; color: #555;">åœ¨å³ä¾§è¾¹æ ç‚¹å‡»"é€‰æ‹©å¹³é¢å›¾"æŒ‰é’®ï¼Œä¸Šä¼ æ‚¨çš„è½¦é—´å¸ƒå±€å›¾ï¼ˆæ”¯æŒ JPGã€PNG æ ¼å¼ï¼‰</p>
                </div>

                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">ç¬¬äºŒæ­¥ï¼šæ¡†é€‰åŒºåŸŸ</h4>
                    <p style="margin: 0 0 10px 0; color: #555;">1. ç‚¹å‡»å·¥å…·æ ä¸­çš„"âœï¸ æ¡†é€‰åŒºåŸŸ"æŒ‰é’®</p>
                    <p style="margin: 0 0 10px 0; color: #555;">2. åœ¨åœ°å›¾ä¸ŠæŒ‰ä½é¼ æ ‡å·¦é”®æ‹–æ‹½ï¼Œç»˜åˆ¶çŸ©å½¢åŒºåŸŸ</p>
                    <p style="margin: 0; color: #555;">3. æ¾å¼€é¼ æ ‡åï¼Œè¾“å…¥åŒºåŸŸåç§°ï¼ˆå¦‚ï¼š"ç”Ÿäº§åŒºA"ã€"ä»“å‚¨åŒº"ï¼‰</p>
                </div>

                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ é£é™©ç‚¹ï¼ˆä¸¤ç§æ–¹å¼ï¼‰</h4>

                    <p style="font-weight: bold; margin: 10px 0 5px 0; color: #333;">æ–¹å¼1ï¼šæ‰‹åŠ¨æ·»åŠ </p>
                    <p style="margin: 0 0 5px 0; color: #555;">1. ç‚¹å‡»"â• æ·»åŠ é£é™©ç‚¹"æŒ‰é’®</p>
                    <p style="margin: 0 0 5px 0; color: #555;">2. åœ¨åœ°å›¾ä¸Šç‚¹å‡»è¦æ·»åŠ é£é™©ç‚¹çš„ä½ç½®</p>
                    <p style="margin: 0 0 10px 0; color: #555;">3. å¡«å†™é£é™©ç‚¹ä¿¡æ¯ï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æ‰€å±åŒºåŸŸï¼‰</p>

                    <p style="font-weight: bold; margin: 10px 0 5px 0; color: #333;">æ–¹å¼2ï¼šæ‰¹é‡å¯¼å…¥</p>
                    <p style="margin: 0 0 5px 0; color: #555;">1. ç‚¹å‡»"ğŸ“¥ ä¸‹è½½Excelæ¨¡æ¿"</p>
                    <p style="margin: 0 0 5px 0; color: #555;">2. å¡«å†™é£é™©ç‚¹ä¿¡æ¯ï¼ˆæ‰€å±åŒºåŸŸå¯ä¸å¡«ï¼Œç³»ç»Ÿæ ¹æ®åæ ‡è‡ªåŠ¨åˆ¤æ–­ï¼‰</p>
                    <p style="margin: 0; color: #555;">3. ç‚¹å‡»"ğŸ“Š ä¸Šä¼ Excelè¡¨æ ¼"æ‰¹é‡å¯¼å…¥</p>
                </div>

                <h3 style="color: #2c3e50; margin: 25px 0 15px 0;">ğŸ› ï¸ å·¥å…·æ è¯´æ˜</h3>

                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left; width: 150px;">æŒ‰é’®</th>
                        <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">åŠŸèƒ½è¯´æ˜</th>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #dee2e6;">âš¡ é€‰æ‹©æ¨¡å¼</td>
                        <td style="padding: 10px; border: 1px solid #dee2e6;">ç‚¹å‡»é€‰ä¸­åŒºåŸŸæˆ–é£é™©ç‚¹ï¼ŒæŸ¥çœ‹è¯¦æƒ…</td>
                    </tr>
                    <tr style="background: #f8f9fa;">
                        <td style="padding: 10px; border: 1px solid #dee2e6;">âœï¸ æ¡†é€‰åŒºåŸŸ</td>
                        <td style="padding: 10px; border: 1px solid #dee2e6;">æ‹–æ‹½é¼ æ ‡ç»˜åˆ¶çŸ©å½¢åŒºåŸŸ</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #dee2e6;">â• æ·»åŠ é£é™©ç‚¹</td>
                        <td style="padding: 10px; border: 1px solid #dee2e6;">ç‚¹å‡»åœ°å›¾ä½ç½®æ·»åŠ å•ä¸ªé£é™©ç‚¹</td>
                    </tr>
                    <tr style="background: #f8f9fa;">
                        <td style="padding: 10px; border: 1px solid #dee2e6;">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</td>
                        <td style="padding: 10px; border: 1px solid #dee2e6;">åˆ é™¤å½“å‰é€‰ä¸­çš„åŒºåŸŸæˆ–é£é™©ç‚¹</td>
                    </tr>
                </table>

                <h3 style="color: #2c3e50; margin: 25px 0 15px 0;">ğŸ’¡ ä½¿ç”¨æŠ€å·§</h3>

                <ul style="line-height: 2; color: #555;">
                    <li><strong>è‡ªåŠ¨è¯†åˆ«åŒºåŸŸï¼š</strong>æ·»åŠ é£é™©ç‚¹æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®åæ ‡è‡ªåŠ¨åˆ¤æ–­æ‰€å±åŒºåŸŸ</li>
                    <li><strong>æŸ¥çœ‹åŒºåŸŸé£é™©ï¼š</strong>åœ¨é€‰æ‹©æ¨¡å¼ä¸‹ç‚¹å‡»åŒºåŸŸï¼Œè¯¥åŒºåŸŸå†…çš„æ‰€æœ‰é£é™©ç‚¹ä¼šé«˜äº®æ˜¾ç¤º</li>
                    <li><strong>é£é™©ç»Ÿè®¡ï¼š</strong>åŒºåŸŸåˆ—è¡¨ä¼šæ˜¾ç¤ºæ¯ä¸ªåŒºåŸŸåŒ…å«çš„é£é™©ç‚¹æ•°é‡</li>
                    <li><strong>æ•°æ®ä¿å­˜ï¼š</strong>ç‚¹å‡»"å¯¼å‡ºæ‰€æœ‰æ•°æ®"ä¿å­˜é…ç½®ï¼Œæ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥åˆ°å±•ç¤ºé¡µé¢</li>
                    <li><strong>åæ ‡è¯´æ˜ï¼š</strong>X/Y åæ ‡ä½¿ç”¨ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰ï¼Œä¸å®é™…å›¾ç‰‡å°ºå¯¸æ— å…³</li>
                </ul>

                <h3 style="color: #2c3e50; margin: 25px 0 15px 0;">ğŸ¨ é£é™©ç­‰çº§è¯´æ˜</h3>

                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                    <div style="flex: 1; min-width: 150px; padding: 15px; background: #dc3545; color: white; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 5px;">ğŸ”´</div>
                        <div style="font-weight: bold;">é‡å¤§é£é™©</div>
                    </div>
                    <div style="flex: 1; min-width: 150px; padding: 15px; background: #fd7e14; color: white; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 5px;">ğŸŸ </div>
                        <div style="font-weight: bold;">è¾ƒå¤§é£é™©</div>
                    </div>
                    <div style="flex: 1; min-width: 150px; padding: 15px; background: #ffc107; color: #000; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 5px;">ğŸŸ¡</div>
                        <div style="font-weight: bold;">ä¸€èˆ¬é£é™©</div>
                    </div>
                    <div style="flex: 1; min-width: 150px; padding: 15px; background: #0dcaf0; color: white; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 5px;">ğŸ”µ</div>
                        <div style="font-weight: bold;">ä½é£é™©</div>
                    </div>
                </div>

                <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                    <h4 style="margin: 0 0 10px 0; color: #721c24;">âš ï¸ æ³¨æ„äº‹é¡¹</h4>
                    <ul style="margin: 0; color: #721c24; line-height: 1.8;">
                        <li>åˆ é™¤åŒºåŸŸä¸ä¼šåˆ é™¤è¯¥åŒºåŸŸå†…çš„é£é™©ç‚¹ï¼Œé£é™©ç‚¹ä¼šå˜æˆ"æœªåˆ†é…"çŠ¶æ€</li>
                        <li>å¯¼å‡ºæ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨ï¼Œåˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±æ•°æ®</li>
                        <li>å»ºè®®å®šæœŸç‚¹å‡»"å¯¼å‡ºæ‰€æœ‰æ•°æ®"å¤‡ä»½åˆ°æœ¬åœ°æ–‡ä»¶</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- åŒºåŸŸå››è‰²å›¾ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div class="modal" id="detailImageModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">ğŸ“Š ä¸Šä¼ åŒºåŸŸå››è‰²å›¾</div>
                <span class="modal-close" onclick="closeDetailImageModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 20px;">
                    ä¸º <strong id="detailAreaName"></strong> ä¸Šä¼ æ›´è¯¦ç»†çš„å››è‰²å›¾ï¼ˆå¯ä¸Šä¼ å¤šå¼ ï¼‰ã€‚å±•ç¤ºé¡µé¢åŒå‡»è¯¥åŒºåŸŸæ—¶ä¼šæ˜¾ç¤ºè¿™äº›å›¾ç‰‡ã€‚
                </div>

                <!-- å·²ä¸Šä¼ çš„å›¾ç‰‡åˆ—è¡¨ -->
                <div id="uploadedImagesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                </div>

                <div id="detailImagePlaceholder" style="padding: 40px 20px; background: #f8f9fa; border: 2px dashed #CCCCCC; border-radius: 8px; color: #6c757d; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ–¼ï¸</div>
                    <div>æš‚æ— å››è‰²å›¾</div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <label class="btn btn-primary" style="margin: 0;">
                        ğŸ“¤ æ·»åŠ å›¾ç‰‡
                        <input type="file" id="detailImageInput" accept="image/*" multiple style="display: none;" onchange="handleDetailImageUpload(event)">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script src="xlsx.full.min.js"></script>

    <script>
        let backgroundImage = null;
        let areas = [];  // åŒºåŸŸåˆ—è¡¨
        let riskPoints = [];  // é£é™©ç‚¹åˆ—è¡¨
        let currentMode = 'select';  // å½“å‰æ¨¡å¼: select/draw/addRisk
        let isDrawing = false;
        let startX, startY;
        let currentArea = null;
        let selectedItem = null;
        let tempRiskPoint = null;
        let currentEditingAreaId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘å››è‰²å›¾çš„åŒºåŸŸID

        const riskColors = {
            red: '#dc3545',
            orange: '#fd7e14',
            yellow: '#ffc107',
            blue: '#0dcaf0'
        };

        // ä¸Šä¼ å›¾ç‰‡
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                backgroundImage = e.target.result;
                const img = document.getElementById('workshopImage');
                img.src = backgroundImage;
                img.style.display = 'block';
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('imageInfo').innerHTML =
                    `âœ… å·²ä¸Šä¼ ï¼š${file.name}`;
                autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
            };
            reader.readAsDataURL(file);
        }

        // è®¾ç½®æ¨¡å¼
        function setMode(mode) {
            currentMode = mode;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('selectModeBtn').style.background = mode === 'select' ? '#0b5ed7' : '';
            document.getElementById('drawModeBtn').style.background = mode === 'draw' ? '#ffca2c' : '';
            document.getElementById('addRiskBtn').style.background = mode === 'addRisk' ? '#157347' : '';

            // æ›´æ–°å…‰æ ‡
            const map = document.getElementById('workshopMap');
            map.style.cursor = mode === 'draw' ? 'crosshair' : mode === 'addRisk' ? 'pointer' : 'default';

            // æ˜¾ç¤ºå¯¹åº”é¢æ¿
            document.getElementById('areaPanel').style.display = mode === 'draw' ? 'block' : 'none';
            document.getElementById('riskPanel').style.display = mode === 'addRisk' ? 'block' : 'none';

            // åœ¨æ·»åŠ é£é™©ç‚¹æ¨¡å¼ä¸‹ï¼Œè®©åŒºåŸŸæ¡†ä¸å“åº”ç‚¹å‡»
            const areaBoxes = document.querySelectorAll('.area-box');
            areaBoxes.forEach(box => {
                box.style.pointerEvents = mode === 'addRisk' ? 'none' : 'auto';
            });

            // å–æ¶ˆé€‰ä¸­
            selectedItem = null;
            renderAreas();
            renderRisks();
        }

        // åœ°å›¾é¼ æ ‡äº‹ä»¶
        const map = document.getElementById('workshopMap');

        map.onmousedown = function(e) {
            if (e.target !== map) return;

            const rect = map.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (currentMode === 'draw') {
                isDrawing = true;
                startX = x;
                startY = y;
                currentArea = document.createElement('div');
                currentArea.className = 'area-box';
                currentArea.style.left = x + 'px';
                currentArea.style.top = y + 'px';
                currentArea.style.width = '0px';
                currentArea.style.height = '0px';
                map.appendChild(currentArea);
            } else if (currentMode === 'addRisk') {
                const editingId = document.getElementById('editingRiskId').value;
                const isEditing = editingId !== '';

                tempRiskPoint = {
                    x: (x / rect.width) * 100,
                    y: (y / rect.height) * 100
                };

                // æ›´æ–°åæ ‡è¾“å…¥æ¡†
                document.getElementById('riskX').value = tempRiskPoint.x.toFixed(1);
                document.getElementById('riskY').value = tempRiskPoint.y.toFixed(1);

                // æ¸…é™¤ä¹‹å‰çš„ä¸´æ—¶æ ‡è®°
                const oldMarker = document.getElementById('tempMarker');
                if (oldMarker) oldMarker.remove();

                // æ·»åŠ ä¸´æ—¶åæ ‡æ ‡è®°
                const marker = document.createElement('div');
                marker.id = 'tempMarker';
                marker.className = 'temp-marker';
                marker.textContent = 'ğŸ“';
                marker.style.left = tempRiskPoint.x + '%';
                marker.style.top = tempRiskPoint.y + '%';
                map.appendChild(marker);

                // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼ŒåŒæ—¶æ›´æ–°æ­£åœ¨ç¼–è¾‘çš„é£é™©ç‚¹çš„æ˜¾ç¤ºä½ç½®
                if (isEditing) {
                    const risk = riskPoints.find(r => r.id == editingId);
                    if (risk) {
                        risk.x = tempRiskPoint.x;
                        risk.y = tempRiskPoint.y;
                        renderRisks();
                    }
                }

                // è‡ªåŠ¨è¯†åˆ«æ‰€å±åŒºåŸŸå¹¶æ›´æ–°æ˜¾ç¤º
                const areaId = findAreaByPoint(tempRiskPoint.x, tempRiskPoint.y);
                if (areaId) {
                    const area = areas.find(a => a.id == areaId);
                    document.getElementById('riskArea').textContent = `ğŸ“ ${area.name}`;
                    if (isEditing) {
                        document.getElementById('riskPanelHint').textContent = `æ­£åœ¨ç¼–è¾‘ - ä½ç½®å·²æ›´æ–°åˆ°ï¼š${area.name}`;
                    } else {
                        document.getElementById('riskPanelHint').textContent = `ç‚¹å‡»ä½ç½®åœ¨ï¼š${area.name}`;
                    }
                } else {
                    document.getElementById('riskArea').textContent = 'ï¼ˆæœªåœ¨ä»»ä½•åŒºåŸŸå†…ï¼‰';
                    if (isEditing) {
                        document.getElementById('riskPanelHint').textContent = 'æ­£åœ¨ç¼–è¾‘ - ä½ç½®å·²æ›´æ–°ï¼ˆæœªåœ¨ä»»ä½•åŒºåŸŸå†…ï¼‰';
                    } else {
                        document.getElementById('riskPanelHint').textContent = 'ç‚¹å‡»ä½ç½®æœªåœ¨ä»»ä½•åŒºåŸŸå†…';
                    }
                }

                if (!isEditing) {
                    document.getElementById('riskName').focus();
                }
            }
        };

        map.onmousemove = function(e) {
            if (!isDrawing || currentMode !== 'draw') return;

            const rect = map.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const width = x - startX;
            const height = y - startY;

            if (width > 0) {
                currentArea.style.width = width + 'px';
            } else {
                currentArea.style.left = x + 'px';
                currentArea.style.width = Math.abs(width) + 'px';
            }

            if (height > 0) {
                currentArea.style.height = height + 'px';
            } else {
                currentArea.style.top = y + 'px';
                currentArea.style.height = Math.abs(height) + 'px';
            }
        };

        map.onmouseup = function(e) {
            if (isDrawing && currentMode === 'draw') {
                isDrawing = false;

                // è½¬æ¢ä¸ºç™¾åˆ†æ¯”åæ ‡
                const rect = map.getBoundingClientRect();
                const areaRect = currentArea.getBoundingClientRect();

                const newAreaData = {
                    x: ((areaRect.left - rect.left) / rect.width) * 100,
                    y: ((areaRect.top - rect.top) / rect.height) * 100,
                    width: (areaRect.width / rect.width) * 100,
                    height: (areaRect.height / rect.height) * 100
                };

                // å¦‚æœåŒºåŸŸå¤ªå°ï¼Œåˆ é™¤
                if (newAreaData.width < 2 || newAreaData.height < 2) {
                    currentArea.remove();
                    currentArea = null;
                    return;
                }

                currentArea.remove();
                currentArea = null;

                // åˆ¤æ–­æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼
                if (selectedItem && selectedItem.type === 'area') {
                    // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰åŒºåŸŸçš„ä½ç½®å’Œå¤§å°
                    selectedItem.data.x = newAreaData.x;
                    selectedItem.data.y = newAreaData.y;
                    selectedItem.data.width = newAreaData.width;
                    selectedItem.data.height = newAreaData.height;

                    // æ˜¾ç¤ºåŒºåŸŸé¢æ¿ï¼Œå…è®¸ä¿®æ”¹åç§°
                    document.getElementById('areaPanel').style.display = 'block';
                    document.getElementById('areaName').value = selectedItem.data.name;

                    renderAreas();
                } else {
                    // æ–°å»ºæ¨¡å¼ï¼šåˆ›å»ºæ–°åŒºåŸŸ
                    const name = prompt('è¯·è¾“å…¥åŒºåŸŸåç§°ï¼š');
                    if (name && name.trim()) {
                        const area = {
                            id: Date.now(),
                            name: name.trim(),
                            ...newAreaData
                        };
                        areas.push(area);
                        renderAreas();
                        updateAreaSelect();
                        updateCounts();
                        autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
                    }
                }
            }
        };

        // ä¿å­˜åŒºåŸŸ
        function saveArea() {
            const name = document.getElementById('areaName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥åŒºåŸŸåç§°');
                return;
            }

            if (selectedItem && selectedItem.type === 'area') {
                // æ›´æ–°åŒºåŸŸåç§°
                selectedItem.data.name = name;
                renderAreas();
                renderAreaList();
                updateAreaSelect();
                autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜

                // æ¸…ç©ºè¡¨å•å¹¶é€€å‡ºç¼–è¾‘æ¨¡å¼
                document.getElementById('areaName').value = '';
                document.getElementById('areaPanel').style.display = 'none';
                selectedItem = null;
                setMode('select');

                alert('åŒºåŸŸå·²ä¿å­˜');
            }
        }

        // æ ¹æ®åæ ‡æŸ¥æ‰¾æ‰€å±åŒºåŸŸ
        function findAreaByPoint(x, y) {
            for (let area of areas) {
                if (x >= area.x && x <= area.x + area.width &&
                    y >= area.y && y <= area.y + area.height) {
                    return area.id;
                }
            }
            return '';
        }

        // ä¿å­˜é£é™©ç‚¹
        function saveRisk() {
            const editingId = document.getElementById('editingRiskId').value;
            const isEditing = editingId !== '';

            // å¦‚æœæ˜¯æ–°å¢ï¼Œéœ€è¦æœ‰tempRiskPoint
            if (!isEditing && !tempRiskPoint) {
                alert('è¯·å…ˆåœ¨åœ°å›¾ä¸Šç‚¹å‡»ä¸€ä¸ªä½ç½®');
                return;
            }

            const name = document.getElementById('riskName').value.trim();
            const level = document.getElementById('riskLevel').value;

            if (!name || !level) {
                alert('è¯·å¡«å†™å¿…å¡«é¡¹');
                return;
            }

            if (isEditing) {
                // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰é£é™©ç‚¹
                const risk = riskPoints.find(r => r.id == editingId);
                if (risk) {
                    // ä½¿ç”¨tempRiskPointçš„åæ ‡ï¼ˆå¯èƒ½å·²è¢«ç”¨æˆ·é‡æ–°ç‚¹å‡»æ›´æ”¹ï¼‰
                    if (tempRiskPoint) {
                        risk.x = tempRiskPoint.x;
                        risk.y = tempRiskPoint.y;
                    }

                    // è‡ªåŠ¨åˆ¤æ–­æ‰€å±åŒºåŸŸ
                    risk.areaId = findAreaByPoint(risk.x, risk.y);
                    risk.name = name;
                    risk.level = level;
                    risk.riskCode = document.getElementById('riskCode').value;
                    risk.riskDescription = document.getElementById('riskDescription').value;
                    risk.riskType = document.getElementById('riskType').value;
                    risk.controlMeasures = document.getElementById('controlMeasures').value;
                    risk.responsibleDept = document.getElementById('responsibleDept').value;
                    risk.responsible = document.getElementById('riskResponsible').value;

                    // ä¿å­˜ç…§ç‰‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    const photoImg = document.getElementById('riskPhotoImg');
                    if (photoImg.src && photoImg.src.startsWith('data:')) {
                        risk.photo = photoImg.src;
                    } else if (!photoImg.src || photoImg.src === '') {
                        delete risk.photo;
                    }

                    renderRisks();
                    renderRiskList();
                    renderAreas(); // æ›´æ–°åŒºåŸŸé¢œè‰²
                    renderAreaList(); // æ›´æ–°åŒºåŸŸåˆ—è¡¨ä¸­çš„é£é™©ç‚¹æ•°é‡
                    updateCounts();
                    autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜

                    // æ¸…ç©ºè¡¨å•å¹¶åˆ‡æ¢å›é€‰æ‹©æ¨¡å¼
                    clearRiskForm();
                    setMode('select');
                    alert('é£é™©ç‚¹å·²æ›´æ–°');
                }
            } else {
                // æ–°å¢æ¨¡å¼ï¼šè‡ªåŠ¨åˆ¤æ–­æ‰€å±åŒºåŸŸ
                const areaId = findAreaByPoint(tempRiskPoint.x, tempRiskPoint.y);
                if (areaId) {
                    const area = areas.find(a => a.id == areaId);
                    console.log(`è‡ªåŠ¨åˆ†é…åˆ°åŒºåŸŸï¼š${area.name}`);
                }

                const risk = {
                    id: Date.now(),
                    areaId: areaId,
                    name: name,
                    level: level,
                    x: tempRiskPoint.x,
                    y: tempRiskPoint.y,
                    riskCode: document.getElementById('riskCode').value,
                    riskDescription: document.getElementById('riskDescription').value,
                    riskType: document.getElementById('riskType').value,
                    controlMeasures: document.getElementById('controlMeasures').value,
                    responsibleDept: document.getElementById('responsibleDept').value,
                    responsible: document.getElementById('riskResponsible').value
                };

                // ä¿å­˜ç…§ç‰‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const photoImg = document.getElementById('riskPhotoImg');
                if (photoImg.src && photoImg.src.startsWith('data:')) {
                    risk.photo = photoImg.src;
                }

                riskPoints.push(risk);
                renderRisks();
                renderRiskList();
                renderAreas(); // æ›´æ–°åŒºåŸŸé¢œè‰²
                renderAreaList(); // æ›´æ–°åŒºåŸŸåˆ—è¡¨ä¸­çš„é£é™©ç‚¹æ•°é‡
                updateCounts();
                autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜

                // æ¸…ç©ºè¡¨å•
                clearRiskForm();
            }
        }

        // æ¸…ç©ºé£é™©ç‚¹è¡¨å•
        function clearRiskForm() {
            document.getElementById('editingRiskId').value = '';
            document.getElementById('riskName').value = '';
            document.getElementById('riskCode').value = '';
            document.getElementById('riskLevel').value = '';
            document.getElementById('riskDescription').value = '';
            document.getElementById('riskType').value = '';
            document.getElementById('controlMeasures').value = '';
            document.getElementById('responsibleDept').value = '';
            document.getElementById('riskResponsible').value = '';
            document.getElementById('riskArea').value = '';
            document.getElementById('riskX').value = '';
            document.getElementById('riskY').value = '';
            document.getElementById('riskPanelHint').textContent = 'ç‚¹å‡»åœ°å›¾æ·»åŠ é£é™©ç‚¹';

            // æ¸…ç©ºç…§ç‰‡é¢„è§ˆ
            clearRiskPhoto();

            tempRiskPoint = null;

            // ç§»é™¤ä¸´æ—¶æ ‡è®°
            const marker = document.getElementById('tempMarker');
            if (marker) marker.remove();
        }

        // å–æ¶ˆæ·»åŠ /ç¼–è¾‘é£é™©ç‚¹
        function cancelRisk() {
            clearRiskForm();
            setMode('select');
        }

        // æ ¹æ®åŒºåŸŸå†…é£é™©ç‚¹çš„æ•°é‡å’Œç­‰çº§ï¼Œè®¡ç®—åŒºåŸŸçš„é£é™©ç³»æ•°
        function calculateAreaRiskScore(areaId) {
            const risksInArea = riskPoints.filter(r => r.areaId == areaId);
            if (risksInArea.length === 0) return 0;

            // é£é™©ç­‰çº§æƒé‡
            const weights = {
                red: 4,    // é‡å¤§é£é™©
                orange: 3, // è¾ƒå¤§é£é™©
                yellow: 2, // ä¸€èˆ¬é£é™©
                blue: 1    // ä½é£é™©
            };

            // è®¡ç®—åŠ æƒæ€»åˆ†
            let totalScore = 0;
            risksInArea.forEach(risk => {
                totalScore += weights[risk.level] || 0;
            });

            return totalScore;
        }

        // è·å–æ‰€æœ‰åŒºåŸŸçš„æœ€å¤§é£é™©ç³»æ•°ï¼ˆç”¨äºå½’ä¸€åŒ–ï¼‰
        function getMaxRiskScore() {
            let maxScore = 0;
            areas.forEach(area => {
                const score = calculateAreaRiskScore(area.id);
                if (score > maxScore) maxScore = score;
            });
            return maxScore || 1; // é¿å…é™¤ä»¥0
        }

        // æ ¹æ®é£é™©ç³»æ•°è·å–é¢œè‰²ï¼ˆè“è‰²â†’é»„è‰²â†’æ©™è‰²â†’çº¢è‰²æ¸å˜ï¼‰
        function getColorByRiskScore(score, maxScore) {
            if (score === 0) {
                // æ— é£é™©ï¼Œè¿”å›é»˜è®¤æ·¡é’ç»¿è‰²
                return {
                    background: 'rgba(0, 114, 109, 0.05)',
                    border: 'rgba(0, 114, 109, 0.5)'
                };
            }

            // å½’ä¸€åŒ–åˆ°0-1
            const normalized = score / maxScore;

            let r, g, b;

            if (normalized <= 0.33) {
                // è“è‰² (13, 202, 240) â†’ é»„è‰² (255, 193, 7)
                const t = normalized / 0.33;
                r = Math.round(13 + (255 - 13) * t);
                g = Math.round(202 + (193 - 202) * t);
                b = Math.round(240 + (7 - 240) * t);
            } else if (normalized <= 0.67) {
                // é»„è‰² (255, 193, 7) â†’ æ©™è‰² (253, 126, 20)
                const t = (normalized - 0.33) / 0.34;
                r = Math.round(255 + (253 - 255) * t);
                g = Math.round(193 + (126 - 193) * t);
                b = Math.round(7 + (20 - 7) * t);
            } else {
                // æ©™è‰² (253, 126, 20) â†’ çº¢è‰² (220, 53, 69)
                const t = (normalized - 0.67) / 0.33;
                r = Math.round(253 + (220 - 253) * t);
                g = Math.round(126 + (53 - 126) * t);
                b = Math.round(20 + (69 - 20) * t);
            }

            return {
                background: `rgba(${r}, ${g}, ${b}, 0.15)`,
                border: `rgba(${r}, ${g}, ${b}, 0.6)`
            };
        }

        // æ¸²æŸ“åŒºåŸŸ
        function renderAreas() {
            const map = document.getElementById('workshopMap');

            // æ¸…é™¤ç°æœ‰åŒºåŸŸ
            map.querySelectorAll('.area-box').forEach(el => el.remove());

            // è®¡ç®—æœ€å¤§é£é™©ç³»æ•°ï¼ˆç”¨äºå½’ä¸€åŒ–ï¼‰
            const maxScore = getMaxRiskScore();

            // æ¸²æŸ“æ‰€æœ‰åŒºåŸŸ
            areas.forEach(area => {
                const box = document.createElement('div');
                box.className = 'area-box';
                if (selectedItem && selectedItem.type === 'area' && selectedItem.data.id === area.id) {
                    box.classList.add('selected');
                    // å¦‚æœåœ¨æ¡†é€‰æ¨¡å¼ä¸‹ä¸”è¯¥åŒºåŸŸè¢«é€‰ä¸­ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰ï¼Œåˆ™éšè—è¯¥åŒºåŸŸæ¡†ä»¥ä¾¿é‡æ–°æ¡†é€‰
                    if (currentMode === 'draw') {
                        box.style.opacity = '0.3';
                        box.style.pointerEvents = 'none';
                    }
                }
                box.style.left = area.x + '%';
                box.style.top = area.y + '%';
                box.style.width = area.width + '%';
                box.style.height = area.height + '%';

                // åœ¨æ·»åŠ é£é™©ç‚¹æ¨¡å¼ä¸‹ï¼Œè®©åŒºåŸŸæ¡†ä¸å“åº”ç‚¹å‡»
                // åœ¨ç¼–è¾‘æŸä¸ªåŒºåŸŸæ—¶ï¼Œå…¶ä»–åŒºåŸŸä¹Ÿä¸å“åº”ç‚¹å‡»
                if (currentMode === 'addRisk') {
                    box.style.pointerEvents = 'none';
                } else if (currentMode === 'draw' && selectedItem && selectedItem.type === 'area') {
                    // ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œéé€‰ä¸­åŒºåŸŸå¯ä»¥ç‚¹å‡»åˆ‡æ¢ç¼–è¾‘å¯¹è±¡
                    if (selectedItem.data.id !== area.id) {
                        box.style.pointerEvents = 'auto';
                    }
                } else if (currentMode === 'draw') {
                    // æ¡†é€‰æ¨¡å¼ä½†æ²¡æœ‰é€‰ä¸­åŒºåŸŸæ—¶ï¼Œå¯ä»¥ç‚¹å‡»åŒºåŸŸè¿›å…¥ç¼–è¾‘
                    box.style.pointerEvents = 'auto';
                } else {
                    box.style.pointerEvents = 'auto';
                }

                // æ ¹æ®é£é™©ç³»æ•°è®¾ç½®é¢œè‰²
                const riskScore = calculateAreaRiskScore(area.id);
                const colors = getColorByRiskScore(riskScore, maxScore);
                box.style.background = colors.background;
                box.style.borderColor = colors.border;

                const label = document.createElement('div');
                label.className = 'area-label';
                label.textContent = area.name;
                box.appendChild(label);

                box.onclick = function(e) {
                    e.stopPropagation();
                    if (currentMode === 'select') {
                        selectedItem = { type: 'area', data: area };
                        renderAreas();
                        renderAreaList();
                    } else if (currentMode === 'draw') {
                        // æ¡†é€‰æ¨¡å¼ä¸‹ç‚¹å‡»å·²æœ‰åŒºåŸŸï¼Œè¿›å…¥ç¼–è¾‘æ¨¡å¼
                        editAreaInDrawMode(area);
                    }
                };

                // åŒå‡»äº‹ä»¶ï¼šåœ¨é€‰æ‹©æ¨¡å¼ä¸‹ä¸Šä¼ å››è‰²å›¾
                box.ondblclick = function(e) {
                    e.stopPropagation();
                    if (currentMode === 'select') {
                        openDetailImageModal(area.id);
                    }
                };

                map.appendChild(box);
            });

            renderAreaList();
        }

        // æ¸²æŸ“åŒºåŸŸåˆ—è¡¨ï¼ˆç”¨äºå¼¹çª—ï¼‰
        function renderAreaList() {
            const list = document.getElementById('areaListContent');
            if (!list) return; // å¦‚æœå…ƒç´ ä¸å­˜åœ¨åˆ™é€€å‡º

            if (areas.length === 0) {
                list.innerHTML = '<div style="padding: 20px; color: #666666; text-align: center;">æš‚æ— åŒºåŸŸ</div>';
                return;
            }

            list.innerHTML = '<table style="width: 100%; border-collapse: collapse;">' +
                '<thead>' +
                '<tr style="background: #f8f9fa; border-bottom: 2px solid #CCCCCC;">' +
                '<th style="padding: 12px; text-align: left; color: #002D28;">åŒºåŸŸåç§°</th>' +
                '<th style="padding: 12px; text-align: center; color: #002D28;">é£é™©ç‚¹æ•°</th>' +
                '<th style="padding: 12px; text-align: center; color: #002D28;">é£é™©ç³»æ•°</th>' +
                '<th style="padding: 12px; text-align: center; color: #002D28;">æ“ä½œ</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>' +
                areas.map(area => {
                    const riskCount = riskPoints.filter(r => r.areaId == area.id).length;
                    const riskScore = calculateAreaRiskScore(area.id);
                    return `
                    <tr style="border-bottom: 1px solid #CCCCCC;">
                        <td style="padding: 12px;"><strong>${area.name}</strong></td>
                        <td style="padding: 12px; text-align: center;">${riskCount}</td>
                        <td style="padding: 12px; text-align: center;">${riskScore}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #00726d; color: white; margin-right: 5px;"
                                    onclick="editAreaFromModal(${area.id})">ç¼–è¾‘</button>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #0d6efd; color: white; margin-right: 5px;"
                                    onclick="viewAreaRisks(${area.id})">æŸ¥çœ‹é£é™©ç‚¹</button>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #dc3545; color: white;"
                                    onclick="deleteAreaFromModal(${area.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `}).join('') +
                '</tbody>' +
                '</table>';
        }

        // æ¸²æŸ“é£é™©ç‚¹åˆ—è¡¨ï¼ˆç”¨äºå¼¹çª—ï¼‰
        function renderRiskList() {
            const list = document.getElementById('riskListContent');
            if (!list) return; // å¦‚æœå…ƒç´ ä¸å­˜åœ¨åˆ™é€€å‡º

            // è·å–ç­›é€‰æ¡ä»¶
            const searchText = document.getElementById('riskSearchInput')?.value.toLowerCase() || '';
            const levelFilter = document.getElementById('riskLevelFilter')?.value || '';
            const areaFilter = document.getElementById('riskAreaFilter')?.value || '';

            // åº”ç”¨ç­›é€‰
            let filteredRisks = riskPoints.filter(risk => {
                // åç§°æœç´¢
                if (searchText && !risk.name.toLowerCase().includes(searchText)) {
                    return false;
                }
                // ç­‰çº§ç­›é€‰
                if (levelFilter && risk.level !== levelFilter) {
                    return false;
                }
                // åŒºåŸŸç­›é€‰
                if (areaFilter && risk.areaId != areaFilter) {
                    return false;
                }
                return true;
            });

            if (filteredRisks.length === 0) {
                list.innerHTML = '<div style="padding: 20px; color: #666666; text-align: center;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é£é™©ç‚¹</div>';
                return;
            }

            const riskLevelNames = {
                red: 'ğŸ”´ é‡å¤§',
                orange: 'ğŸŸ  è¾ƒå¤§',
                yellow: 'ğŸŸ¡ ä¸€èˆ¬',
                blue: 'ğŸ”µ ä½'
            };

            list.innerHTML = '<table style="width: 100%; border-collapse: collapse; font-size: 13px;">' +
                '<thead>' +
                '<tr style="background: #f8f9fa; border-bottom: 2px solid #CCCCCC;">' +
                '<th style="padding: 10px; text-align: left; color: #002D28;">åç§°</th>' +
                '<th style="padding: 10px; text-align: center; color: #002D28;">ç­‰çº§</th>' +
                '<th style="padding: 10px; text-align: left; color: #002D28;">åŒºåŸŸ</th>' +
                '<th style="padding: 10px; text-align: left; color: #002D28;">ç±»å‹</th>' +
                '<th style="padding: 10px; text-align: center; color: #002D28;">æ“ä½œ</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>' +
                filteredRisks.map(risk => {
                    const areaName = areas.find(a => a.id == risk.areaId)?.name || 'æœªåˆ†é…';
                    return `
                    <tr style="border-bottom: 1px solid #CCCCCC;">
                        <td style="padding: 10px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${risk.name}">
                            <strong>${risk.name}</strong>
                        </td>
                        <td style="padding: 10px; text-align: center;">${riskLevelNames[risk.level]}</td>
                        <td style="padding: 10px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${areaName}">
                            ${areaName}
                        </td>
                        <td style="padding: 10px; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${risk.riskType || '-'}">
                            ${risk.riskType || '-'}
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <button class="btn" style="padding: 4px 8px; font-size: 11px; background: #00726d; color: white; margin-right: 3px;"
                                    onclick="editRiskFromModal(${risk.id})">ç¼–è¾‘</button>
                            <button class="btn" style="padding: 4px 8px; font-size: 11px; background: #dc3545; color: white;"
                                    onclick="deleteRiskFromModal(${risk.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `}).join('') +
                '</tbody>' +
                '</table>';
        }

        // æ˜¾ç¤ºåŒºåŸŸåˆ—è¡¨å¼¹çª—
        function showAreaListModal() {
            renderAreaList();
            document.getElementById('areaListModal').classList.add('active');
        }

        // å…³é—­åŒºåŸŸåˆ—è¡¨å¼¹çª—
        function closeAreaListModal() {
            document.getElementById('areaListModal').classList.remove('active');
        }

        // æ˜¾ç¤ºé£é™©ç‚¹åˆ—è¡¨å¼¹çª—
        function showRiskListModal() {
            // éšè—è¿”å›æŒ‰é’®ï¼ˆæ­£å¸¸æ‰“å¼€æ—¶ï¼‰
            document.getElementById('backToAreaListBtn').style.display = 'none';

            // æ›´æ–°åŒºåŸŸç­›é€‰å™¨é€‰é¡¹
            const areaFilterSelect = document.getElementById('riskAreaFilter');
            if (areaFilterSelect) {
                areaFilterSelect.innerHTML = '<option value="">å…¨éƒ¨åŒºåŸŸ</option>' +
                    areas.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            }

            renderRiskList();
            document.getElementById('riskListModal').classList.add('active');
        }

        // å…³é—­é£é™©ç‚¹åˆ—è¡¨å¼¹çª—
        function closeRiskListModal() {
            document.getElementById('riskListModal').classList.remove('active');
        }

        // ç­›é€‰é£é™©ç‚¹åˆ—è¡¨
        function filterRiskList() {
            renderRiskList();
        }

        // é‡ç½®é£é™©ç‚¹ç­›é€‰å™¨
        function resetRiskFilters() {
            document.getElementById('riskSearchInput').value = '';
            document.getElementById('riskLevelFilter').value = '';
            document.getElementById('riskAreaFilter').value = '';
            renderRiskList();
        }

        // ä»åŒºåŸŸåˆ—è¡¨æŸ¥çœ‹è¯¥åŒºåŸŸçš„é£é™©ç‚¹
        function viewAreaRisks(areaId) {
            // å…³é—­åŒºåŸŸåˆ—è¡¨å¼¹çª—
            closeAreaListModal();

            // æ›´æ–°åŒºåŸŸç­›é€‰å™¨é€‰é¡¹
            const areaFilterSelect = document.getElementById('riskAreaFilter');
            if (areaFilterSelect) {
                areaFilterSelect.innerHTML = '<option value="">å…¨éƒ¨åŒºåŸŸ</option>' +
                    areas.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            }

            // é‡ç½®å…¶ä»–ç­›é€‰å™¨
            document.getElementById('riskSearchInput').value = '';
            document.getElementById('riskLevelFilter').value = '';

            // è®¾ç½®åŒºåŸŸç­›é€‰å™¨ä¸ºæŒ‡å®šåŒºåŸŸ
            document.getElementById('riskAreaFilter').value = areaId;

            // æ˜¾ç¤ºè¿”å›æŒ‰é’®
            document.getElementById('backToAreaListBtn').style.display = 'block';

            // æ¸²æŸ“é£é™©ç‚¹åˆ—è¡¨
            renderRiskList();

            // æ‰“å¼€é£é™©ç‚¹åˆ—è¡¨å¼¹çª—
            document.getElementById('riskListModal').classList.add('active');
        }

        // ä»é£é™©ç‚¹åˆ—è¡¨è¿”å›åŒºåŸŸåˆ—è¡¨
        function backToAreaList() {
            // éšè—è¿”å›æŒ‰é’®
            document.getElementById('backToAreaListBtn').style.display = 'none';

            // å…³é—­é£é™©ç‚¹åˆ—è¡¨å¼¹çª—
            closeRiskListModal();

            // æ‰“å¼€åŒºåŸŸåˆ—è¡¨å¼¹çª—
            showAreaListModal();
        }

        // ä»å¼¹çª—ä¸­é€‰ä¸­åŒºåŸŸ
        function selectAreaFromModal(id) {
            const area = areas.find(a => a.id === id);
            if (area) {
                selectedItem = { type: 'area', data: area };
                setMode('select');
                renderAreas();
                renderRisks();
                closeAreaListModal();
            }
        }

        // ä»å¼¹çª—ä¸­ç¼–è¾‘åŒºåŸŸ
        function editAreaFromModal(id) {
            const area = areas.find(a => a.id === id);
            if (!area) return;

            // å…³é—­å¼¹çª—
            closeAreaListModal();

            // è°ƒç”¨ç»Ÿä¸€çš„ç¼–è¾‘å‡½æ•°
            editAreaInDrawMode(area);
        }

        // åœ¨æ¡†é€‰æ¨¡å¼ä¸‹ç¼–è¾‘åŒºåŸŸï¼ˆç»Ÿä¸€çš„ç¼–è¾‘å…¥å£ï¼‰
        function editAreaInDrawMode(area) {
            // é€‰ä¸­è¯¥åŒºåŸŸ
            selectedItem = { type: 'area', data: area };

            // åˆ‡æ¢åˆ°æ¡†é€‰æ¨¡å¼
            setMode('draw');

            // æ˜¾ç¤ºåŒºåŸŸä¿¡æ¯é¢æ¿
            document.getElementById('areaPanel').style.display = 'block';
            document.getElementById('areaName').value = area.name;

            renderAreas();
        }

        // ä»å¼¹çª—ä¸­åˆ é™¤åŒºåŸŸ
        function deleteAreaFromModal(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥åŒºåŸŸå—ï¼Ÿ')) return;
            areas = areas.filter(a => a.id !== id);
            selectedItem = null;
            renderAreas();
            renderAreaList();
            updateAreaSelect();
            updateCounts();
            autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
        }

        // ä»å¼¹çª—ä¸­ç¼–è¾‘é£é™©ç‚¹
        function editRiskFromModal(id) {
            closeRiskListModal();
            editRisk(id);
        }

        // ä»å¼¹çª—ä¸­åˆ é™¤é£é™©ç‚¹
        function deleteRiskFromModal(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥é£é™©ç‚¹å—ï¼Ÿ')) return;
            riskPoints = riskPoints.filter(r => r.id !== id);
            selectedItem = null;
            renderRisks();
            renderRiskList();
            renderAreas(); // æ›´æ–°åŒºåŸŸé¢œè‰²
            renderAreaList(); // æ›´æ–°åŒºåŸŸåˆ—è¡¨ä¸­çš„é£é™©ç‚¹æ•°é‡
            updateCounts();
            autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.addEventListener('DOMContentLoaded', function() {
            const areaModal = document.getElementById('areaListModal');
            if (areaModal) {
                areaModal.onclick = function(e) {
                    if (e.target === areaModal) closeAreaListModal();
                };
            }

            const riskModal = document.getElementById('riskListModal');
            if (riskModal) {
                riskModal.onclick = function(e) {
                    if (e.target === riskModal) closeRiskListModal();
                };
            }
        });

        // æ¸²æŸ“é£é™©ç‚¹
        function renderRisks() {
            const map = document.getElementById('workshopMap');

            // æ¸…é™¤ç°æœ‰é£é™©ç‚¹
            map.querySelectorAll('.risk-point').forEach(el => el.remove());

            // æ¸²æŸ“æ‰€æœ‰é£é™©ç‚¹
            riskPoints.forEach(risk => {
                const point = document.createElement('div');
                point.className = 'risk-point';
                point.style.left = risk.x + '%';
                point.style.top = risk.y + '%';
                point.style.background = riskColors[risk.level];
                point.textContent = 'â—';

                // å¦‚æœé€‰ä¸­çš„æ˜¯åŒºåŸŸï¼Œä¸”è¯¥é£é™©ç‚¹å±äºè¯¥åŒºåŸŸï¼Œåˆ™é«˜äº®æ˜¾ç¤º
                if (selectedItem && selectedItem.type === 'area' && selectedItem.data.id == risk.areaId) {
                    point.style.transform = 'scale(1.3)';
                    point.style.boxShadow = '0 0 0 3px rgba(255, 193, 7, 0.5), 0 2px 8px rgba(0, 0, 0, 0.3)';
                }

                // å¦‚æœæ˜¯å½“å‰é€‰ä¸­æˆ–æ­£åœ¨ç¼–è¾‘çš„é£é™©ç‚¹
                if (selectedItem && selectedItem.type === 'risk' && selectedItem.data.id === risk.id) {
                    point.style.transform = 'scale(1.3)';
                    point.style.boxShadow = '0 0 0 3px rgba(255, 193, 7, 0.8), 0 2px 8px rgba(0, 0, 0, 0.3)';
                }

                point.onclick = function(e) {
                    e.stopPropagation();
                    if (currentMode === 'select') {
                        selectedItem = { type: 'risk', data: risk };
                        renderRisks();
                        renderRiskList();
                    }
                };

                // åŒå‡»ç¼–è¾‘
                point.ondblclick = function(e) {
                    e.stopPropagation();
                    if (currentMode === 'select') {
                        editRisk(risk.id);
                    }
                };

                map.appendChild(point);
            });

            renderRiskList();
        }


        // ç¼–è¾‘é£é™©ç‚¹
        function editRisk(id) {
            const risk = riskPoints.find(r => r.id === id);
            if (risk) {
                // åˆ‡æ¢åˆ°æ·»åŠ é£é™©ç‚¹æ¨¡å¼
                setMode('addRisk');

                // å¡«å……è¡¨å•
                document.getElementById('editingRiskId').value = risk.id;
                document.getElementById('riskName').value = risk.name;
                document.getElementById('riskCode').value = risk.riskCode || '';
                document.getElementById('riskLevel').value = risk.level;
                document.getElementById('riskDescription').value = risk.riskDescription || '';
                document.getElementById('riskType').value = risk.riskType || '';
                document.getElementById('controlMeasures').value = risk.controlMeasures || '';
                document.getElementById('responsibleDept').value = risk.responsibleDept || '';
                document.getElementById('riskResponsible').value = risk.responsible || '';

                // æ˜¾ç¤ºç…§ç‰‡
                if (risk.photo) {
                    document.getElementById('riskPhotoImg').src = risk.photo;
                    document.getElementById('riskPhotoPreview').style.display = 'block';
                } else {
                    clearRiskPhoto();
                }

                // æ˜¾ç¤ºå½“å‰æ‰€å±åŒºåŸŸ
                if (risk.areaId) {
                    const area = areas.find(a => a.id == risk.areaId);
                    if (area) {
                        document.getElementById('riskArea').textContent = `ğŸ“ ${area.name}`;
                    } else {
                        document.getElementById('riskArea').textContent = 'ï¼ˆæœªåœ¨ä»»ä½•åŒºåŸŸå†…ï¼‰';
                    }
                } else {
                    document.getElementById('riskArea').textContent = 'ï¼ˆæœªåœ¨ä»»ä½•åŒºåŸŸå†…ï¼‰';
                }

                document.getElementById('riskX').value = risk.x.toFixed(1);
                document.getElementById('riskY').value = risk.y.toFixed(1);
                document.getElementById('riskPanelHint').textContent = 'æ­£åœ¨ç¼–è¾‘ï¼š' + risk.name + 'ï¼ˆå¯ç‚¹å‡»åœ°å›¾é‡æ–°å®šä½ï¼‰';

                // è®¾ç½®tempRiskPointä¸ºå½“å‰åæ ‡
                tempRiskPoint = {
                    x: risk.x,
                    y: risk.y
                };

                // åœ¨åœ°å›¾ä¸Šæ·»åŠ ä¸´æ—¶æ ‡è®°
                const oldMarker = document.getElementById('tempMarker');
                if (oldMarker) oldMarker.remove();

                const marker = document.createElement('div');
                marker.id = 'tempMarker';
                marker.className = 'temp-marker';
                marker.textContent = 'ğŸ“';
                marker.style.left = risk.x + '%';
                marker.style.top = risk.y + '%';
                document.getElementById('workshopMap').appendChild(marker);

                // æ ‡è®°ä¸ºé€‰ä¸­
                selectedItem = { type: 'risk', data: risk };
                renderRisks();
            }
        }

        // åˆ é™¤é€‰ä¸­é¡¹
        function deleteSelected() {
            if (!selectedItem) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®');
                return;
            }

            if (!confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) return;

            if (selectedItem.type === 'area') {
                deleteArea(selectedItem.data.id);
            } else {
                deleteRisk(selectedItem.data.id);
            }
        }

        // åˆ é™¤åŒºåŸŸ
        function deleteArea(id) {
            areas = areas.filter(a => a.id !== id);
            selectedItem = null;
            renderAreas();
            renderAreaList();
            updateAreaSelect();
            updateCounts();
            autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
        }

        // åˆ é™¤é£é™©ç‚¹
        function deleteRisk(id) {
            riskPoints = riskPoints.filter(r => r.id !== id);
            selectedItem = null;
            renderRisks();
            renderRiskList();
            renderAreas(); // æ›´æ–°åŒºåŸŸé¢œè‰²
            renderAreaList(); // æ›´æ–°åŒºåŸŸåˆ—è¡¨ä¸­çš„é£é™©ç‚¹æ•°é‡
            updateCounts();
            autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
        }

        // æ›´æ–°åŒºåŸŸä¸‹æ‹‰æ¡†ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰
        function updateAreaSelect() {
            // åŒºåŸŸé€‰æ‹©å·²æ”¹ä¸ºè‡ªåŠ¨è¯†åˆ«ï¼Œä¸å†éœ€è¦æ‰‹åŠ¨é€‰æ‹©
            // ä¿ç•™æ­¤å‡½æ•°ä»¥å…¼å®¹å…¶ä»–è°ƒç”¨
        }

        // æ›´æ–°è®¡æ•°
        function updateCounts() {
            document.getElementById('areaCount').textContent = areas.length;
            document.getElementById('riskCount').textContent = riskPoints.length;
        }

        // å¤„ç†Excelä¸Šä¼ 
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    let successCount = 0;
                    let errorCount = 0;
                    let errorMessages = [];

                    jsonData.forEach((row, index) => {
                        try {
                            const rowNum = index + 2; // Excelè¡Œå·ï¼ˆä»2å¼€å§‹ï¼Œå› ä¸ºç¬¬1è¡Œæ˜¯è¡¨å¤´ï¼‰

                            // å…¼å®¹æ—§å­—æ®µåå’Œæ–°å­—æ®µå
                            const name = row['é£é™©ç‚¹åç§°'] || row['åŒºåŸŸåç§°'];
                            const riskType = row['æ˜“å‘ç”Ÿçš„äº‹æ•…ç±»å‹'] || row['é£é™©ç±»å‹'];

                            // æ£€æŸ¥å¿…å¡«å­—æ®µ
                            if (!name) {
                                errorCount++;
                                errorMessages.push(`ç¬¬${rowNum}è¡Œï¼šç¼ºå°‘"é£é™©ç‚¹åç§°"`);
                                return;
                            }
                            if (!row['é£é™©ç­‰çº§']) {
                                errorCount++;
                                errorMessages.push(`ç¬¬${rowNum}è¡Œï¼šç¼ºå°‘"é£é™©ç­‰çº§"`);
                                return;
                            }
                            if (!row['Xåæ ‡(%)'] && row['Xåæ ‡(%)'] !== 0) {
                                errorCount++;
                                errorMessages.push(`ç¬¬${rowNum}è¡Œï¼šç¼ºå°‘"Xåæ ‡(%)"`);
                                return;
                            }
                            if (!row['Yåæ ‡(%)'] && row['Yåæ ‡(%)'] !== 0) {
                                errorCount++;
                                errorMessages.push(`ç¬¬${rowNum}è¡Œï¼šç¼ºå°‘"Yåæ ‡(%)"`);
                                return;
                            }

                            // éªŒè¯é£é™©ç­‰çº§
                            let level = '';
                            const levelText = row['é£é™©ç­‰çº§'].toString().toLowerCase();
                            // æ”¯æŒä¸¤ç§æ ¼å¼ï¼šé‡å¤§é£é™©/è¾ƒå¤§é£é™©/ä¸€èˆ¬é£é™©/ä½é£é™© æˆ– çº¢è‰²/æ©™è‰²/é»„è‰²/è“è‰²
                            if (levelText.includes('é‡å¤§') || levelText.includes('çº¢') || levelText === 'red') level = 'red';
                            else if (levelText.includes('è¾ƒå¤§') || levelText.includes('æ©™') || levelText === 'orange') level = 'orange';
                            else if (levelText.includes('ä¸€èˆ¬') || levelText.includes('é»„') || levelText === 'yellow') level = 'yellow';
                            else if (levelText.includes('ä½') || levelText.includes('è“') || levelText === 'blue') level = 'blue';
                            else {
                                errorCount++;
                                errorMessages.push(`ç¬¬${rowNum}è¡Œï¼šé£é™©ç­‰çº§"${row['é£é™©ç­‰çº§']}"ä¸æ­£ç¡®ï¼Œåº”ä¸ºï¼šé‡å¤§é£é™©/è¾ƒå¤§é£é™©/ä¸€èˆ¬é£é™©/ä½é£é™©`);
                                return;
                            }

                            // éªŒè¯åæ ‡
                            const x = parseFloat(row['Xåæ ‡(%)']);
                            const y = parseFloat(row['Yåæ ‡(%)']);

                            if (isNaN(x) || x < 0 || x > 100) {
                                errorCount++;
                                errorMessages.push(`ç¬¬${rowNum}è¡Œï¼šXåæ ‡"${row['Xåæ ‡(%)']}"ä¸æ­£ç¡®ï¼Œåº”ä¸º0-100çš„æ•°å­—`);
                                return;
                            }
                            if (isNaN(y) || y < 0 || y > 100) {
                                errorCount++;
                                errorMessages.push(`ç¬¬${rowNum}è¡Œï¼šYåæ ‡"${row['Yåæ ‡(%)']}"ä¸æ­£ç¡®ï¼Œåº”ä¸º0-100çš„æ•°å­—`);
                                return;
                            }

                            // æŸ¥æ‰¾æ‰€å±åŒºåŸŸï¼šä¼˜å…ˆä½¿ç”¨"æ‰€å±åŒºåŸŸ"å­—æ®µï¼Œå…¶æ¬¡æ ¹æ®åæ ‡è‡ªåŠ¨åˆ¤æ–­
                            let areaId = '';
                            if (row['æ‰€å±åŒºåŸŸ']) {
                                const area = areas.find(a => a.name === row['æ‰€å±åŒºåŸŸ']);
                                if (area) {
                                    areaId = area.id;
                                }
                            }

                            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒºåŸŸï¼Œåˆ™æ ¹æ®åæ ‡è‡ªåŠ¨åˆ¤æ–­
                            if (!areaId) {
                                areaId = findAreaByPoint(x, y);
                            }

                            const risk = {
                                id: Date.now() + successCount,
                                areaId: areaId,
                                name: name,
                                riskCode: row['é£é™©ä»£ç '] || '',
                                level: level,
                                riskDescription: row['é£é™©æè¿°'] || '',
                                x: x,
                                y: y,
                                riskType: riskType || '',
                                controlMeasures: row['ä¸»è¦ç®¡æ§æªæ–½'] || '',
                                responsibleDept: row['è´£ä»»éƒ¨é—¨'] || '',
                                responsible: row['è´£ä»»äºº'] || ''
                            };

                            riskPoints.push(risk);
                            successCount++;
                        } catch (err) {
                            errorCount++;
                            errorMessages.push(`ç¬¬${index + 2}è¡Œï¼šæ•°æ®å¤„ç†å¼‚å¸¸ - ${err.message}`);
                        }
                    });

                    renderRisks();
                    renderAreas(); // æ›´æ–°åŒºåŸŸé¢œè‰²
                    renderAreaList(); // æ›´æ–°åŒºåŸŸåˆ—è¡¨
                    updateCounts();
                    autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜

                    // æ„å»ºæç¤ºæ¶ˆæ¯
                    let message = `å¯¼å…¥å®Œæˆï¼\næˆåŠŸï¼š${successCount} ä¸ª\nå¤±è´¥ï¼š${errorCount} ä¸ª`;
                    if (errorCount > 0 && errorMessages.length > 0) {
                        message += '\n\nå¤±è´¥åŸå› ï¼š\n';
                        // æœ€å¤šæ˜¾ç¤ºå‰10æ¡é”™è¯¯
                        const displayErrors = errorMessages.slice(0, 10);
                        message += displayErrors.join('\n');
                        if (errorMessages.length > 10) {
                            message += `\n... è¿˜æœ‰ ${errorMessages.length - 10} æ¡é”™è¯¯`;
                        }
                    }

                    alert(message);
                    event.target.value = '';
                } catch (err) {
                    alert('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼š' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ä¸‹è½½Excelæ¨¡æ¿
        function downloadTemplate() {
            const templateData = [
                {
                    'åºå·': 1,
                    'æ‰€å±åŒºåŸŸ': 'ç”Ÿäº§åŒºA',
                    'é£é™©ç‚¹åç§°': 'è®¾å¤‡A1',
                    'é£é™©ä»£ç ': 'FX-001',
                    'é£é™©ç­‰çº§': 'è¾ƒå¤§é£é™©',
                    'é£é™©æè¿°': 'è®¾å¤‡è¿è½¬æ—¶å­˜åœ¨æœºæ¢°ä¼¤å®³é£é™©',
                    'Xåæ ‡(%)': 20,
                    'Yåæ ‡(%)': 30,
                    'æ˜“å‘ç”Ÿçš„äº‹æ•…ç±»å‹': 'æœºæ¢°ä¼¤å®³',
                    'ä¸»è¦ç®¡æ§æªæ–½': '1.å®šæœŸæ£€æŸ¥è®¾å¤‡å®‰å…¨é˜²æŠ¤è£…ç½®\n2.æ“ä½œäººå‘˜å¿…é¡»ç»è¿‡åŸ¹è®­\n3.ç©¿æˆ´å¥½åŠ³ä¿ç”¨å“',
                    'è´£ä»»éƒ¨é—¨': 'ç”Ÿäº§éƒ¨',
                    'è´£ä»»äºº': 'å¼ ä¸‰'
                }
            ];

            const ws = XLSX.utils.json_to_sheet(templateData);
            ws['!cols'] = [
                { wch: 8 },  // åºå·
                { wch: 15 }, // æ‰€å±åŒºåŸŸ
                { wch: 18 }, // é£é™©ç‚¹åç§°
                { wch: 12 }, // é£é™©ä»£ç 
                { wch: 12 }, // é£é™©ç­‰çº§
                { wch: 30 }, // é£é™©æè¿°
                { wch: 12 }, // Xåæ ‡
                { wch: 12 }, // Yåæ ‡
                { wch: 18 }, // æ˜“å‘ç”Ÿçš„äº‹æ•…ç±»å‹
                { wch: 40 }, // ä¸»è¦ç®¡æ§æªæ–½
                { wch: 12 }, // è´£ä»»éƒ¨é—¨
                { wch: 10 }  // è´£ä»»äºº
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'é£é™©ç‚¹æ•°æ®');

            const instructions = [
                { 'å­—æ®µåç§°': 'åºå·', 'è¯´æ˜': 'é€‰å¡«ï¼Œå¯¼å…¥æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆ', 'ç¤ºä¾‹': '1' },
                { 'å­—æ®µåç§°': 'æ‰€å±åŒºåŸŸ', 'è¯´æ˜': 'é€‰å¡«ï¼Œç³»ç»Ÿä¼šæ ¹æ®åæ ‡è‡ªåŠ¨åˆ¤æ–­', 'ç¤ºä¾‹': 'ç”Ÿäº§åŒºA' },
                { 'å­—æ®µåç§°': 'é£é™©ç‚¹åç§°', 'è¯´æ˜': 'å¿…å¡«ï¼Œé£é™©ç‚¹çš„åç§°', 'ç¤ºä¾‹': 'è®¾å¤‡A1' },
                { 'å­—æ®µåç§°': 'é£é™©ä»£ç ', 'è¯´æ˜': 'é€‰å¡«ï¼Œé£é™©ç‚¹ç¼–ç ', 'ç¤ºä¾‹': 'FX-001' },
                { 'å­—æ®µåç§°': 'é£é™©ç­‰çº§', 'è¯´æ˜': 'å¿…å¡«ï¼Œé‡å¤§é£é™©/è¾ƒå¤§é£é™©/ä¸€èˆ¬é£é™©/ä½é£é™©', 'ç¤ºä¾‹': 'è¾ƒå¤§é£é™©' },
                { 'å­—æ®µåç§°': 'é£é™©æè¿°', 'è¯´æ˜': 'é€‰å¡«ï¼Œæè¿°é£é™©å†…å®¹', 'ç¤ºä¾‹': 'è®¾å¤‡è¿è½¬æ—¶å­˜åœ¨æœºæ¢°ä¼¤å®³é£é™©' },
                { 'å­—æ®µåç§°': 'Xåæ ‡(%)', 'è¯´æ˜': 'å¿…å¡«ï¼Œ0-100çš„æ•°å­—', 'ç¤ºä¾‹': '20' },
                { 'å­—æ®µåç§°': 'Yåæ ‡(%)', 'è¯´æ˜': 'å¿…å¡«ï¼Œ0-100çš„æ•°å­—', 'ç¤ºä¾‹': '30' },
                { 'å­—æ®µåç§°': 'æ˜“å‘ç”Ÿçš„äº‹æ•…ç±»å‹', 'è¯´æ˜': 'é€‰å¡«ï¼Œå¯èƒ½å‘ç”Ÿçš„äº‹æ•…ç±»å‹', 'ç¤ºä¾‹': 'æœºæ¢°ä¼¤å®³' },
                { 'å­—æ®µåç§°': 'ä¸»è¦ç®¡æ§æªæ–½', 'è¯´æ˜': 'é€‰å¡«ï¼Œé£é™©ç®¡æ§æªæ–½', 'ç¤ºä¾‹': 'å®šæœŸæ£€æŸ¥è®¾å¤‡å®‰å…¨é˜²æŠ¤è£…ç½®' },
                { 'å­—æ®µåç§°': 'è´£ä»»éƒ¨é—¨', 'è¯´æ˜': 'é€‰å¡«ï¼Œè´Ÿè´£éƒ¨é—¨', 'ç¤ºä¾‹': 'ç”Ÿäº§éƒ¨' },
                { 'å­—æ®µåç§°': 'è´£ä»»äºº', 'è¯´æ˜': 'é€‰å¡«ï¼Œè´Ÿè´£äººå§“å', 'ç¤ºä¾‹': 'å¼ ä¸‰' }
            ];

            const wsInstructions = XLSX.utils.json_to_sheet(instructions);
            wsInstructions['!cols'] = [
                { wch: 20 },
                { wch: 35 },
                { wch: 35 }
            ];
            XLSX.utils.book_append_sheet(wb, wsInstructions, 'å¡«å†™è¯´æ˜');

            XLSX.writeFile(wb, 'è½¦é—´é£é™©ç‚¹å¯¼å…¥æ¨¡æ¿.xlsx');
        }

        // è‡ªåŠ¨ä¿å­˜æ•°æ®åˆ° localStorageï¼ˆä¾›å±•ç¤ºé¡µé¢ä½¿ç”¨ï¼‰
        function autoSaveToLocalStorage() {
            const data = {
                backgroundImage: backgroundImage,
                areas: areas,
                riskPoints: riskPoints
            };
            localStorage.setItem('workshopRiskData', JSON.stringify(data));
            console.log('æ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ° localStorage');
        }

        // å¯¼å‡ºæ‰€æœ‰æ•°æ®
        function exportAllData() {
            const data = {
                backgroundImage: backgroundImage,
                areas: areas,
                riskPoints: riskPoints,
                exportTime: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è½¦é—´é£é™©æ•°æ®_${new Date().toLocaleDateString()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            // åŒæ—¶ä¿å­˜åˆ°localStorage
            localStorage.setItem('workshopRiskData', JSON.stringify(data));
            alert('æ•°æ®å·²å¯¼å‡ºå¹¶è‡ªåŠ¨ä¿å­˜ï¼');
        }

        // æ‰“å¼€å±•ç¤ºé¡µé¢
        function openDisplayPage() {
            // ä¿å­˜æ•°æ®åˆ°localStorage
            const data = {
                backgroundImage: backgroundImage,
                areas: areas,
                riskPoints: riskPoints
            };
            localStorage.setItem('workshopRiskData', JSON.stringify(data));

            // æ‰“å¼€æ–°çª—å£
            window.open('workshop-risk-display.html', '_blank');
        }

        // æ˜¾ç¤ºå¸®åŠ©è¯´æ˜
        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        // å…³é—­å¸®åŠ©è¯´æ˜
        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // æ‰“å¼€å››è‰²å›¾ä¸Šä¼ æ¨¡æ€æ¡†
        function openDetailImageModal(areaId) {
            currentEditingAreaId = areaId;
            const area = areas.find(a => a.id === areaId);
            if (!area) return;

            document.getElementById('detailAreaName').textContent = area.name;

            // åˆå§‹åŒ–detailImagesæ•°ç»„ï¼ˆå‘åå…¼å®¹æ—§æ•°æ®ï¼‰
            if (!area.detailImages) {
                area.detailImages = [];
                // å¦‚æœæœ‰æ—§çš„detailImageï¼Œè¿ç§»åˆ°æ•°ç»„
                if (area.detailImage) {
                    area.detailImages.push(area.detailImage);
                    delete area.detailImage;
                }
            }

            // æ¸²æŸ“å·²ä¸Šä¼ çš„å›¾ç‰‡
            renderUploadedImages();

            document.getElementById('detailImageModal').classList.add('active');
        }

        // æ¸²æŸ“å·²ä¸Šä¼ çš„å›¾ç‰‡åˆ—è¡¨
        function renderUploadedImages() {
            const area = areas.find(a => a.id === currentEditingAreaId);
            if (!area) return;

            const listContainer = document.getElementById('uploadedImagesList');
            const placeholder = document.getElementById('detailImagePlaceholder');

            if (!area.detailImages || area.detailImages.length === 0) {
                listContainer.innerHTML = '';
                listContainer.style.display = 'none';
                placeholder.style.display = 'block';
            } else {
                placeholder.style.display = 'none';
                listContainer.style.display = 'grid';
                listContainer.innerHTML = area.detailImages.map((img, index) => `
                    <div style="position: relative; border: 2px solid #CCCCCC; border-radius: 8px; overflow: hidden; background: white;">
                        <img src="${img}" style="width: 100%; height: 150px; object-fit: cover; display: block;">
                        <div style="position: absolute; top: 5px; right: 5px;">
                            <button onclick="removeDetailImageByIndex(${index})"
                                    style="background: rgba(220, 53, 69, 0.9); color: white; border: none; border-radius: 4px;
                                           padding: 5px 10px; cursor: pointer; font-size: 12px; font-weight: bold;">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                        <div style="padding: 5px; text-align: center; font-size: 12px; color: #666;">
                            å›¾ç‰‡ ${index + 1}
                        </div>
                    </div>
                `).join('');
            }
        }

        // å…³é—­å››è‰²å›¾ä¸Šä¼ æ¨¡æ€æ¡†
        function closeDetailImageModal() {
            document.getElementById('detailImageModal').classList.remove('active');
            currentEditingAreaId = null;
            document.getElementById('detailImageInput').value = '';
        }

        // å¤„ç†å››è‰²å›¾ä¸Šä¼ ï¼ˆæ”¯æŒå¤šå¼ ï¼‰
        function handleDetailImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            if (!currentEditingAreaId) {
                alert('æœªæ‰¾åˆ°åŒºåŸŸä¿¡æ¯');
                return;
            }

            const area = areas.find(a => a.id === currentEditingAreaId);
            if (!area) return;

            // åˆå§‹åŒ–æ•°ç»„
            if (!area.detailImages) {
                area.detailImages = [];
            }

            let processedCount = 0;
            const totalFiles = files.length;

            // å¤„ç†æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    area.detailImages.push(e.target.result);
                    processedCount++;

                    // æ‰€æœ‰æ–‡ä»¶éƒ½å¤„ç†å®Œæˆååˆ·æ–°æ˜¾ç¤º
                    if (processedCount === totalFiles) {
                        renderUploadedImages();
                        autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
                        alert(`æˆåŠŸä¸Šä¼  ${totalFiles} å¼ å›¾ç‰‡ï¼`);
                        event.target.value = ''; // æ¸…ç©ºinput
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // åˆ é™¤æŒ‡å®šç´¢å¼•çš„å››è‰²å›¾
        function removeDetailImageByIndex(index) {
            if (!currentEditingAreaId) return;

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;

            const area = areas.find(a => a.id === currentEditingAreaId);
            if (area && area.detailImages) {
                area.detailImages.splice(index, 1);
                renderUploadedImages();
                autoSaveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
            }
        }

        // å¤„ç†é£é™©ç‚¹ç…§ç‰‡ä¸Šä¼ 
        function handleRiskPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('riskPhotoImg');
                img.src = e.target.result;
                document.getElementById('riskPhotoPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // æ¸…é™¤é£é™©ç‚¹ç…§ç‰‡
        function clearRiskPhoto() {
            const img = document.getElementById('riskPhotoImg');
            img.src = '';
            document.getElementById('riskPhotoPreview').style.display = 'none';
            document.getElementById('riskPhotoInput').value = '';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('helpModal');
            if (modal) {
                modal.onclick = function(e) {
                    if (e.target === modal) closeHelp();
                };
            }

            const detailModal = document.getElementById('detailImageModal');
            if (detailModal) {
                detailModal.onclick = function(e) {
                    if (e.target === detailModal) closeDetailImageModal();
                };
            }
        });

        // åˆå§‹åŒ–
        window.onload = function() {
            setMode('select');
            updateCounts();

            // å°è¯•åŠ è½½ä¿å­˜çš„æ•°æ®
            const savedData = localStorage.getItem('workshopRiskData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.backgroundImage) {
                        backgroundImage = data.backgroundImage;
                        const img = document.getElementById('workshopImage');
                        img.src = backgroundImage;
                        img.style.display = 'block';
                        document.getElementById('uploadPlaceholder').classList.add('hidden');
                    }
                    if (data.areas) {
                        areas = data.areas;
                        renderAreas();
                        updateAreaSelect();
                    }
                    if (data.riskPoints) {
                        riskPoints = data.riskPoints;
                        renderRisks();
                    }
                    updateCounts();
                } catch (e) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥', e);
                }
            }
        };
    </script>
</body>
</html>